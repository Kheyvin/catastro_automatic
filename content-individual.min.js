// @ts-nocheck
const STORAGE_KEY="fichaCatastralData",CONFIG={delays:{short:100,medium:300,long:500,extraLong:1e3},selectors:{sectionHeader:".ant-collapse-header",sectionContent:".ant-collapse-content",sectionActive:".ant-collapse-item-active",selectDropdown:".ant-select-dropdown",selectItem:".ant-select-item-option",selectItemContent:".ant-select-item-option-content",modalRoot:".ant-modal-root",modalBody:".ant-modal-body",modalTitle:".ant-modal-title",tableRow:".ant-table-row",paginationTotal:".float-right.font-semibold span.text-black",inputSearch:'input[placeholder="Buscar"]',searchButton:".ant-input-search-button"},defaultValues:{edifica:"01",entrada:"01",piso:"01",unidad:"001",tipoEdificacion:"02 - CASA / CHALET",tipoPuerta:"P - PRINCIPAL",condNumeracion:"01 - GENERADO POR MUNICIPALIDAD",tipoTitular:"01 - PERSONA NATURAL",clasificacionPredio:"01 - CASA HABITACION",predioCatastralEn:"07 - PREDIO INDEPENDIENTE",tipoPartidaRegistral:"03 - PARTIDA ELECTRONICA",ubicacionDomicilio:"01 - IGUAL A UNIDAD UU.CC.",distritoDefault:"CORONEL GREGORIO ALBARRACIN LANCHIPA"}},AppState={storedData:null,currentSection:null,isProcessing:!1,licenseValid:!1};async function verifyLicenseForContentScript(){try{const e=await LicenseManager.verifyLicense();return e.valid?(AppState.licenseValid=!0,log("Licencia verificada correctamente","success"),!0):(AppState.licenseValid=!1,log("Licencia no v谩lida: "+(e.message||"Sin detalles"),"error"),showLicenseNotification(e),!1)}catch(e){return log("Error al verificar licencia: "+e.message,"error"),AppState.licenseValid=!1,!1}}function showLicenseNotification(e){const t=document.getElementById("license-notification-kda");t&&t.remove();const o=document.createElement("div");o.id="license-notification-kda",o.innerHTML=`\n    <div style="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);\n      color: white;\n      padding: 20px 25px;\n      border-radius: 12px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.3);\n      z-index: 999999;\n      max-width: 350px;\n      font-family: 'Segoe UI', Arial, sans-serif;\n    ">\n      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">\n        <span style="font-size: 28px;"></span>\n        <strong style="font-size: 16px;">Webinar Catastro - Licencia Requerida</strong>\n      </div>\n      <p style="margin: 0 0 15px 0; font-size: 13px; opacity: 0.95; line-height: 1.5;">\n        ${e.expired?"Su licencia ha expirado. Por favor renueve para continuar usando la extensi贸n.":e.notFound?"Licencia no encontrada. Por favor active su licencia.":"Se requiere una licencia v谩lida para usar esta extensi贸n."}\n      </p>\n      <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.8;">\n        La automatizaci贸n no se ejecutar谩 hasta que active una licencia v谩lida.\n      </p>\n      <div style="display: flex; gap: 10px; flex-wrap: wrap;">\n        <a href="https://wa.me/51${LICENSE_CONFIG.SUPPORT_PHONE}" target="_blank" style="\n          padding: 8px 16px;\n          background: white;\n          color: #16a34a;\n          text-decoration: none;\n          border-radius: 6px;\n          font-size: 12px;\n          font-weight: 600;\n        "> Contactar: ${LICENSE_CONFIG.SUPPORT_PHONE}</a>\n        <button onclick="this.closest('#license-notification-kda').remove()" style="\n          padding: 8px 16px;\n          background: rgba(255,255,255,0.2);\n          color: white;\n          border: none;\n          border-radius: 6px;\n          font-size: 12px;\n          cursor: pointer;\n        ">Cerrar</button>\n      </div>\n    </div>\n  `,document.body.appendChild(o),setTimeout(()=>{const e=document.getElementById("license-notification-kda");e&&e.remove()},3e4)}async function getStoredData(){return new Promise(e=>{chrome.storage.local.get([STORAGE_KEY],t=>{e(t[STORAGE_KEY]||{})})})}async function saveStoredData(e){return new Promise(t=>{chrome.storage.local.set({[STORAGE_KEY]:e},t)})}async function updateStoredValue(e,t,o){const n=await getStoredData();n[e]||(n[e]={}),n[e][t]=o,await saveStoredData(n),AppState.storedData=n}function delay(e){return new Promise(t=>setTimeout(t,e))}function simulateInput(e,t){if(e){try{let o;e instanceof HTMLInputElement?o=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").set:e instanceof HTMLTextAreaElement&&(o=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value").set),o?o.call(e,t):e.value=t}catch(o){e.value=t}e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new FocusEvent("focus",{bubbles:!0})),e.dispatchEvent(new FocusEvent("blur",{bubbles:!0}))}}function simulateClick(e){if(!e)return!1;const t={bubbles:!0,cancelable:!0,view:window,button:0,buttons:1,clientX:e.getBoundingClientRect?e.getBoundingClientRect().x+5:0,clientY:e.getBoundingClientRect?e.getBoundingClientRect().y+5:0};return e.focus&&e.focus(),e.dispatchEvent(new MouseEvent("mousedown",t)),e.dispatchEvent(new MouseEvent("mouseup",t)),e.dispatchEvent(new MouseEvent("click",t)),!0}function simulateEnter(e){if(!e)return;const t=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0});e.dispatchEvent(t);const o=new KeyboardEvent("keyup",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0});e.dispatchEvent(o)}function log(e,t="info"){const o={info:"color: #3b82f6",success:"color: #22c55e",error:"color: #ef4444",warning:"color: #f59e0b"};console.log("%c[FichaCatastral] "+e,o[t]||o.info)}function waitForElement(e,t=1e4,o=document){return new Promise((n,a)=>{const i=o.querySelector(e);if(i)return void n(i);const c=new MutationObserver((t,a)=>{const i=o.querySelector(e);i&&(a.disconnect(),n(i))});c.observe(o===document?document.body:o,{childList:!0,subtree:!0}),setTimeout(()=>{c.disconnect(),a(new Error("Timeout esperando elemento: "+e))},t)})}function waitForElementToDisappear(e,t=1e4){return new Promise((o,n)=>{if(!document.querySelector(e))return void o();const a=new MutationObserver((t,n)=>{document.querySelector(e)||(n.disconnect(),o())});a.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{a.disconnect(),n(new Error("Timeout esperando que desaparezca: "+e))},t)})}function waitForSectionToExpand(e){return new Promise((t,o)=>{let n;const a=setTimeout(()=>{n&&n.disconnect(),o(new Error("Timeout esperando seccion "+e))},1e4);n=new MutationObserver(o=>{const i=document.querySelectorAll(".ant-collapse-item")[e];if(i&&i.classList.contains("ant-collapse-item-active")){i.querySelector(".ant-collapse-content-active")&&(clearTimeout(a),n.disconnect(),setTimeout(()=>t(i),CONFIG.delays.medium))}}),n.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"]});const i=document.querySelectorAll(".ant-collapse-item")[e];if(i&&i.classList.contains("ant-collapse-item-active")){i.querySelector(".ant-collapse-content-active")&&(clearTimeout(a),n.disconnect(),setTimeout(()=>t(i),CONFIG.delays.medium))}})}function waitForButtonClick(e,t=null){return new Promise(o=>{const n=a=>{const i=a.target.closest("button");if(!i)return;const c=!e||(i.matches(e)||i.closest(e)),l=!t||i.textContent.includes(t);c&&l&&(document.removeEventListener("click",n,!0),o(i))};document.addEventListener("click",n,!0)})}async function openSelector(e){if(!e)return log("Selector no encontrado","error"),null;const t=e.closest(".ant-select")||e,o=t.querySelector(".ant-select-selector");o?(o.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),await delay(50),o.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window})),await delay(50),o.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))):simulateClick(t),await delay(CONFIG.delays.medium);let n=null;for(let e=0;e<10;e++){const e=document.querySelectorAll(".ant-select-dropdown");for(const t of e){const e=window.getComputedStyle(t);if(!(t.classList.contains("ant-select-dropdown-hidden")||"none"===e.display||"none"===t.style.display)&&null!==t.offsetParent){n=t;break}}if(n)break;await delay(100)}return n||(log("No se pudo abrir el dropdown del selector","error"),null)}async function selectOptionByText(e,t,o=!1){const n=await openSelector(e);if(!n)return!1;const a=e=>e.trim().toUpperCase().replace(/\s+/g," ").normalize("NFD").replace(/[\u0300-\u036f]/g,""),i=a(t),c=i.split(" - ")[0].replace(/^0+/,""),l=()=>{const e=n.querySelectorAll(".ant-select-item-option:not(.ant-select-item-option-disabled)");for(const t of e){const e=t.querySelector(".ant-select-item-option-content"),n=e?e.textContent.trim():t.textContent.trim(),l=a(n),r=l.split(" - ")[0].replace(/^0+/,"");if(o){if(l===i)return t}else{if(l===i)return t;if(1===i.length&&/^[A-I]$/.test(i)){if(l===i)return t;continue}if(c&&r&&c===r)return t;if(i.length>1&&(l.includes(i)||i.includes(l)))return t;if(i.length>=3){const e=Math.min(3,i.length);if(l.startsWith(i.substring(0,e)))return t}}}return null},r=n.querySelector(".rc-virtual-list-holder"),s=e.querySelector("input")||e.closest(".ant-select")?.querySelector("input");let u=0;for(;u<100;){const e=l();if(e)return simulateClick(e),await delay(CONFIG.delays.short),log("Opcion seleccionada: "+t,"success"),!0;if(s){const e=new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown",keyCode:40,which:40,bubbles:!0,cancelable:!0});s.dispatchEvent(e)}if(r){const e=r.querySelector(".rc-virtual-list-holder-inner")?.parentElement||r;e.scrollTop+=200,e.dispatchEvent(new Event("scroll",{bubbles:!0}))}await delay(80),u++}return simulateClick(document.body),await delay(CONFIG.delays.short),log("No se encontro la opcion: "+t,"warning"),!1}async function selectByLegend(e,t,o,n=!1){const a=e.querySelectorAll("fieldset");for(const e of a){const a=e.querySelector("legend, label, p, h1");if(a&&a.textContent.includes(t)){const t=e.querySelector(".ant-select");if(t)return await selectOptionByText(t,o,n)}}const i=e.querySelectorAll(".ant-form-item");for(const e of i){const a=e.querySelector(".ant-form-item-label label, .ant-form-item-label, label");if(a&&a.textContent.includes(t)){const t=e.querySelector(".ant-select");if(t)return await selectOptionByText(t,o,n)}}const c=e.querySelectorAll(".ant-select");for(const e of c){const a=e.closest("fieldset, .ant-form-item, .ant-col, .ant-row");if(a){const i=a.querySelector("legend, label, p, h1, .ant-form-item-label");if(i&&i.textContent.includes(t))return await selectOptionByText(e,o,n)}}return log("No se encontro selector para: "+t,"warning"),!1}function removeReadonly(e){if(!e)return;(e.querySelector("input")||e).removeAttribute("readonly");const t=e.closest(".ant-select");if(t){t.querySelectorAll("input").forEach(e=>e.removeAttribute("readonly"))}}async function waitForModal(e,t=1e4){return new Promise((o,n)=>{let a;const i=setTimeout(()=>{a&&a.disconnect(),o(null)},t),c=()=>{try{const t=document.querySelectorAll(".ant-modal");for(const o of t){const t=o.querySelector(".ant-modal-title");if(t&&t.textContent&&t.textContent.toUpperCase().includes(e.toUpperCase()))try{if(null!==o.offsetParent||"none"!==o.style.display)return o}catch(e){continue}}}catch(e){return null}return null},l=c();if(l)return clearTimeout(i),void setTimeout(()=>o(l),CONFIG.delays.medium);a=new MutationObserver(()=>{const e=c();e&&(clearTimeout(i),a.disconnect(),setTimeout(()=>o(e),CONFIG.delays.medium))}),a.observe(document.body,{childList:!0,subtree:!0})})}async function searchInModal(e,t){const o=e.querySelector('input[placeholder="Buscar"]');if(!o)return log("Input de busqueda no encontrado en modal","error"),!1;o.value="",simulateInput(o,t),await delay(CONFIG.delays.medium);const n=e.querySelector(".ant-input-search-button");return n&&(simulateClick(n),await delay(CONFIG.delays.long)),!0}async function waitForSearchResults(e,t=1,o=1e4){return new Promise(n=>{const a=Date.now(),i=setInterval(()=>{const c=(()=>{const t=e.querySelector(".float-right.font-semibold span.text-black");return t?parseInt(t.textContent,10):-1})();c===t?(clearInterval(i),n({count:c,autoSelect:!0})):c>0&&c!==t?(clearInterval(i),n({count:c,autoSelect:!1})):Date.now()-a>o&&(clearInterval(i),n({count:-1,autoSelect:!1}))},500)})}async function selectFirstRecord(e){const t=e.querySelector("button span.anticon-select");return!!t&&(simulateClick(t.closest("button")),await delay(CONFIG.delays.medium),!0)}function waitForUserSelection(e){return new Promise(t=>{const o=new MutationObserver((o,n)=>{document.body.contains(e)&&"none"!==e.style.display||(n.disconnect(),t())});o.observe(document.body,{childList:!0,subtree:!0,attributes:!0});const n=e=>{const a=e.target.closest("button");a&&a.textContent.includes("Seleccionar")&&(document.removeEventListener("click",n,!0),setTimeout(()=>{o.disconnect(),t()},CONFIG.delays.medium))};document.addEventListener("click",n,!0)})}async function handleModalSearch(e,t,o=!0){try{const n=await waitForModal(e);await searchInModal(n,t);const a=await waitForSearchResults(n);return a.autoSelect&&o?(await selectFirstRecord(n),log("Registro seleccionado automaticamente en "+e,"success")):a.count>1&&(log("Multiples registros encontrados ("+a.count+"). Esperando seleccion del usuario...","warning"),await waitForUserSelection(n),log("Usuario selecciono un registro","success")),await delay(CONFIG.delays.medium),!0}catch(e){return log("Error en busqueda de modal: "+e.message,"error"),!1}}function findInputByLegend(e,t){const o=t.toUpperCase(),n=e.querySelectorAll("fieldset");for(const e of n){const t=e.querySelector("legend");if(t&&t.textContent.toUpperCase().includes(o)){const t=e.querySelector('input:not([role="combobox"]):not([type="search"])');if(t)return t}}const a=e.querySelectorAll(".ant-form-item");for(const e of a){const t=e.querySelector(".ant-form-item-label label, label, legend");if(t&&t.textContent.toUpperCase().includes(o)){const t=e.querySelector('input:not([role="combobox"]):not([type="search"])');if(t)return t}}const i=e.querySelectorAll("label, legend, p, h1, h2, h3, span");for(const e of i)if(e.textContent.toUpperCase().includes(o)){const t=e.closest('fieldset, .ant-form-item, .ant-col, .ant-row, div[class*="flex"]');if(t){const e=t.querySelector('input:not([role="combobox"]):not([type="search"])');if(e)return e}const o=e.parentElement;if(o){const e=o.querySelector('input:not([role="combobox"]):not([type="search"])');if(e)return e}}return null}function findSearchButtonByLegend(e,t){const o=t.toUpperCase(),n=e.querySelectorAll("fieldset");for(const e of n){const t=e.querySelector("legend");if(t&&t.textContent.toUpperCase().includes(o)){const t=e.querySelector('button .anticon-search, button[class*="search"]');if(t)return t.closest("button")}}const a=e.querySelectorAll(".ant-form-item");for(const e of a){const t=e.querySelector(".ant-form-item-label label, label, legend, h1");if(t&&t.textContent.toUpperCase().includes(o)){const t=e.querySelector('button .anticon-search, button[class*="search"]');if(t)return t.closest("button")}}const i=e.querySelectorAll("*");for(const e of i)if(0===e.childElementCount&&e.textContent.toUpperCase().includes(o)){const t=e.closest("fieldset, .ant-form-item, .ant-col, .ant-row, div");if(t){const e=t.querySelector("button .anticon-search");if(e)return e.closest("button")}}return null}async function waitForSelectorToBeReady(e,t=1e4){const o=Date.now();for(;Date.now()-o<t;){const t=document.querySelector(`#${e}`);if(!t){await delay(200);continue}const o=t.closest(".ant-select");if(!o){await delay(200);continue}if(!o.classList.contains("ant-select-disabled"))return log(`Selector ${e} esta listo`,"success"),!0;await delay(200)}return log(`Timeout esperando que ${e} este listo`,"warning"),!1}async function selectCascadeOption(e,t){if(!t)return!1;const o=document.querySelector(`#${e}`);if(!o)return log(`Selector ${e} no encontrado`,"error"),!1;const n=o.closest(".ant-select");if(!n)return log(`Contenedor del selector ${e} no encontrado`,"error"),!1;const a=n.querySelector(".ant-select-selection-item");if(a){const o=a.getAttribute("title")||a.textContent.trim();if(o===t||o.includes(t))return log(`${e} ya tiene el valor: ${o}`,"info"),!0}log(`Seleccionando ${e}: ${t}`,"info");const i=n.querySelector(".ant-select-selector");i&&(i.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),await delay(100),i.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))),await delay(CONFIG.delays.medium);let c=null;for(let e=0;e<15;e++){const e=document.querySelectorAll(".ant-select-dropdown");for(const t of e){const e=window.getComputedStyle(t);if(!(t.classList.contains("ant-select-dropdown-hidden")||"none"===e.display)&&null!==t.offsetParent){c=t;break}}if(c)break;await delay(100)}if(!c)return log(`No se pudo abrir el dropdown de ${e}`,"error"),!1;const l=e=>e.toString().trim().toUpperCase().replace(/^0+/,""),r=l(t),s=()=>{const e=c.querySelectorAll(".ant-select-item-option:not(.ant-select-item-option-disabled)");for(const o of e){const e=o.querySelector(".ant-select-item-option-content"),n=e?e.textContent.trim():o.textContent.trim();if(l(n)===r||n===t)return simulateClick(o),!0}return!1},u=c.querySelector(".rc-virtual-list-holder");for(let o=0;o<150;o++){if(s())return await delay(CONFIG.delays.short),log(`Opcion seleccionada en ${e}: ${t}`,"success"),!0;if(u){const e=u,t=e.scrollTop,o=100;e.scrollTop=t+o,e.dispatchEvent(new Event("scroll",{bubbles:!0}));const a=n.querySelector("input");a&&a.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown",keyCode:40,which:40,bubbles:!0,cancelable:!0}))}await delay(50)}return simulateClick(document.body),await delay(CONFIG.delays.short),log(`No se encontro la opcion ${t} en ${e}`,"warning"),!1}async function handleSeccion01Principales(){log("Procesando Seccion 01: PRINCIPALES","info");const e=AppState.storedData,t=e.principales||{},o=e.final||{};await delay(CONFIG.delays.medium);const n=document.querySelector(".ant-collapse-item-active");if(!n)return void log("Seccion PRINCIPALES no esta activa","error");if(t["principales-sector"]){const e=n.querySelector("#form_item_sector");if(e){const o=e.closest(".ant-select"),n=o?o.querySelector(".ant-select-selection-item"):null,a=n?n.getAttribute("title")||n.textContent.trim():"";a&&""!==a?log("Sector ya tiene valor: "+a,"info"):(log("Sector no tiene valor, seleccionando: "+t["principales-sector"],"info"),await selectCascadeOption("form_item_sector",t["principales-sector"]),await delay(CONFIG.delays.medium))}}if(t["principales-manzana"]){await waitForSelectorToBeReady("form_item_manzana",15e3)?(await delay(CONFIG.delays.medium),await selectCascadeOption("form_item_manzana",t["principales-manzana"]),await delay(CONFIG.delays.medium)):log("El selector de manzana no se habilito a tiempo","error")}if(t["principales-lote"]){await waitForSelectorToBeReady("form_item_lote",15e3)?(await delay(CONFIG.delays.medium),await selectCascadeOption("form_item_lote",t["principales-lote"])):log("El selector de lote no se habilito a tiempo","error")}const a=n.querySelector("#form_item_codigoedifica");a&&simulateInput(a,CONFIG.defaultValues.edifica);const i=n.querySelector("#form_item_codigoentrada");i&&simulateInput(i,CONFIG.defaultValues.entrada);const c=n.querySelector("#form_item_codigopiso");c&&simulateInput(c,CONFIG.defaultValues.piso);const l=n.querySelector("#form_item_codigounidad");if(l&&simulateInput(l,CONFIG.defaultValues.unidad),o["final-observaciones"]){const e=document.querySelector('textarea[id*="observacion"]')||document.querySelector('input[id*="observacion"]');e&&simulateInput(e,o["final-observaciones"])}log('Seccion 01 completada. Esperando click en "Guardar principales"...',"success"),await waitForButtonClick("button","Guardar principales"),log("Usuario guardo PRINCIPALES","success"),await delay(CONFIG.delays.medium),await expandAndProcessSection(1)}async function handleSeccion02Ubicacion(){log("Procesando Seccion 02: UBICACION DEL PREDIO","info");const e=AppState.storedData.ubicacion||{};await delay(CONFIG.delays.medium);const t=document.querySelectorAll(".ant-collapse-item")[1];if(!t)return;if(e["ubicacion-manzana"]){const o=findInputByLegend(t,"MANZANA");o&&simulateInput(o,e["ubicacion-manzana"])}if(e["ubicacion-lote"]){const o=findInputByLegend(t,"LOTE");o&&simulateInput(o,e["ubicacion-lote"])}if(e["ubicacion-sub-lote"]){const o=findInputByLegend(t,"SUB-LOTE")||findInputByLegend(t,"SUBLOTE");o&&simulateInput(o,e["ubicacion-sub-lote"])}if(await selectByLegend(t,"TIPO DE EDIFICACI",CONFIG.defaultValues.tipoEdificacion),await delay(CONFIG.delays.medium),e["ubicacion-codigo-hu"]){const o=findSearchButtonByLegend(t,"CODIGO HU")||findSearchButtonByLegend(t,"COD. HU")||findSearchButtonByLegend(t,"DIGO HU");o&&(simulateClick(o),await handleModalSearch("LISTADO DE HABITACIONES URBANAS",e["ubicacion-codigo-hu"]))}await delay(CONFIG.delays.medium);const o=t.querySelectorAll("button");for(const t of o)if(t.textContent.includes("NUEVO")||t.querySelector(".anticon-plus")){simulateClick(t),await delay(CONFIG.delays.long),await handleNuevaUbicacionModal(e);break}log('Seccion 02 completada. Esperando click en "Guardar ubicacion de predio"...',"success"),await waitForButtonClick("button","Guardar ubicaci"),await captureUbicacionData(t),log("Usuario guardo UBICACION","success"),await delay(CONFIG.delays.medium),await expandAndProcessSection(2)}async function handleNuevaUbicacionModal(e){try{const t=await waitForModal("NUEVA UBICACI");if(e["ubicacion-codigo-via"]){const o=t.querySelector("button .anticon-search");o&&(simulateClick(o.closest("button")),await handleModalSearch("LISTADO DE V",e["ubicacion-codigo-via"]))}if(await delay(CONFIG.delays.medium),await selectByLegend(t,"TIPO DE PUERTA",CONFIG.defaultValues.tipoPuerta),await delay(CONFIG.delays.short),await selectByLegend(t,"COND. NUMER",CONFIG.defaultValues.condNumeracion),e["ubicacion-n-municipal"]){const o=t.querySelector("#form_item_numeromunicipal");o&&(simulateInput(o,e["ubicacion-n-municipal"]),o.addEventListener("change",async()=>{await updateStoredValue("ubicacion","ubicacion-n-municipal",o.value)}))}await waitForButtonClick("button.ant-btn-primary","Guardar"),await delay(CONFIG.delays.medium)}catch(e){log("Error en modal Nueva Ubicacion: "+e.message,"error")}}async function captureUbicacionData(e){const t=AppState.storedData;let o="",n="";const a=e.querySelector(".ant-select-selection-item[title]");a&&(o=a.getAttribute("title")||a.textContent.trim());const i=findInputByLegend(e,"NOMBRE DE V")||findInputByLegend(e,"NOMBRE V");i&&(n=i.value.trim());const c=(o+" "+n).trim();c&&" "!==c&&(await updateStoredValue("descripcion","lindero-frente-colindancia",c),log("Colindancia guardada: "+c,"success"));const l=findInputByLegend(e,"MANZANA"),r=findInputByLegend(e,"LOTE"),s=findInputByLegend(e,"SUB-LOTE")||findInputByLegend(e,"SUBLOTE");l&&l.value&&l.value!==(t.ubicacion||{})["ubicacion-manzana"]&&await updateStoredValue("ubicacion","ubicacion-manzana",l.value),r&&r.value&&r.value!==(t.ubicacion||{})["ubicacion-lote"]&&await updateStoredValue("ubicacion","ubicacion-lote",r.value),s&&s.value&&s.value!==(t.ubicacion||{})["ubicacion-sub-lote"]&&await updateStoredValue("ubicacion","ubicacion-sub-lote",s.value)}async function handleSeccion03Titular(){log("Procesando Seccion 03: IDENTIFICACION DEL TITULAR","info"),await delay(CONFIG.delays.medium);const e=document.querySelectorAll(".ant-collapse-item")[2];if(!e)return;await selectByLegend(e,"TIPO DE TITULAR",CONFIG.defaultValues.tipoTitular),await delay(CONFIG.delays.medium);const t=findSearchButtonByLegend(e,"NRO DOC");t&&simulateClick(t),log('Seccion 03 completada. Esperando click en "Guardar identificacion titular catastral"...',"success"),await waitForButtonClick("button","Guardar identificaci"),log("Usuario guardo TITULAR","success"),await delay(CONFIG.delays.medium),await expandAndProcessSection(3)}async function handleSeccion04Domicilio(){log("Procesando Seccion 04: DOMICILIO FISCAL","info");const e=AppState.storedData.ubicacion||{};await delay(CONFIG.delays.medium);const t=document.querySelectorAll(".ant-collapse-item")[3];if(!t)return;log("Esperando que el usuario seleccione la ubicacion...","info");let o=null;if(await new Promise(e=>{const n=setInterval(()=>{const a=t.querySelectorAll(".ant-select-selection-item");for(const t of a){const a=t.textContent||"";if(a.includes("01 - IGUAL A UNIDAD UU.CC."))return o="IGUAL_UNIDAD",clearInterval(n),void e();if(a.includes("02 -")||a.includes("03 -")||a.includes("00 -"))return o="OTRA_OPCION",clearInterval(n),void e()}},500);setTimeout(()=>{clearInterval(n),e()},6e4)}),log(`Usuario selecciono ubicacion: ${o}`,"info"),await delay(CONFIG.delays.medium),"IGUAL_UNIDAD"===o){if(t.querySelector(".ant-select")){const e=t.querySelectorAll(".ant-form-item, fieldset");for(const t of e){const e=t.querySelector("label, legend");if(e&&e.textContent.toUpperCase().includes("DISTRITO")){const e=t.querySelector(".ant-select");if(e){await selectOptionByText(e,CONFIG.defaultValues.distritoDefault),log("DISTRITO seteado: "+CONFIG.defaultValues.distritoDefault,"success");break}}}}if(await delay(CONFIG.delays.medium),e["ubicacion-n-municipal"]){let o=t.querySelector("#form_item_numeromunicipal");if(!o){const e=t.querySelectorAll(".ant-form-item");for(const t of e){const e=t.querySelector("label, legend, p");if(e&&(e.textContent.includes("N掳 MUNICIPAL")||e.textContent.includes("NRO MUNICIPAL")||e.textContent.includes("MUNICIPAL"))){o=t.querySelector('input:not([role="combobox"])');break}}}o||(o=findInputByLegend(t,"MUNICIPAL")),o?(simulateInput(o,e["ubicacion-n-municipal"]),log("N Municipal seteado: "+e["ubicacion-n-municipal"],"success")):log("No se encontro input de N Municipal","warning")}if(e["ubicacion-manzana"]){const o=findInputByLegend(t,"MANZANA");o&&simulateInput(o,e["ubicacion-manzana"])}if(e["ubicacion-lote"]){const o=findInputByLegend(t,"LOTE");o&&simulateInput(o,e["ubicacion-lote"])}if(e["ubicacion-sub-lote"]){const o=findInputByLegend(t,"SUB-LOTE")||findInputByLegend(t,"SUBLOTE");o&&simulateInput(o,e["ubicacion-sub-lote"])}if(await delay(CONFIG.delays.medium),e["ubicacion-codigo-hu"]){const o=findSearchButtonByLegend(t,"DIGO HAB")||findSearchButtonByLegend(t,"COD. HAB");o&&(simulateClick(o),await handleModalSearch("LISTADO DE HABITACIONES URBANAS",e["ubicacion-codigo-hu"]))}if(await delay(CONFIG.delays.medium),e["ubicacion-codigo-via"]){const o=findSearchButtonByLegend(t,"DIGO V")||findSearchButtonByLegend(t,"COD. V");o&&(simulateClick(o),await handleModalSearch("LISTADO DE V",e["ubicacion-codigo-via"]))}}else log('Usuario eligi贸 opci贸n diferente a "IGUAL A UNIDAD UU.CC.", no se auto-poblar谩',"info");log('Seccion 04 completada. Esperando click en "Guardar domicilio fiscal..."',"success"),await waitForButtonClick("button","Guardar domicio fiscal"),log("Usuario guardo DOMICILIO FISCAL","success"),await delay(CONFIG.delays.medium),await expandAndProcessSection(4)}async function handleSeccion05Caracteristicas(){log("Procesando Seccion 05: CARACTERISTICAS DE LA TITULARIDAD","info"),await delay(CONFIG.delays.medium);const e=document.querySelectorAll(".ant-collapse-item")[4];if(!e)return;const t=e.querySelectorAll("fieldset");for(const e of t){const t=e.querySelector("legend");if(t&&(t.textContent.includes("FECHA DE ADQUISI")||t.textContent.includes("[39]"))){e.querySelectorAll(".ant-select").forEach(e=>{e.querySelectorAll("input").forEach(e=>{e.removeAttribute("readonly"),log("Readonly removido del selector MES en FECHA DE ADQUISICION","success")})});break}}const o=e.querySelectorAll(".flex.gap-3");for(const e of o){e.querySelectorAll(".ant-select").forEach(e=>{const t=e.querySelector(".ant-select-selection-item");if(t&&"Mes"===t.textContent.trim()){e.querySelectorAll("input").forEach(e=>{e.removeAttribute("readonly"),log("Readonly removido del selector MES","success")})}})}log('Seccion 05 - Esperando click en "Guardar caracteristicas de la titularidad"...',"success"),await waitForButtonClick("button","Guardar caracter"),log("Usuario guardo CARACTERISTICAS","success"),await delay(CONFIG.delays.medium),await expandAndProcessSection(5)}async function handleSeccion06Descripcion(){log("Procesando Seccion 06: DESCRIPCION DEL PREDIO","info");const e=AppState.storedData.descripcion||{};await delay(CONFIG.delays.medium);const t=document.querySelectorAll(".ant-collapse-item")[5];if(!t)return;if(await selectByLegend(t,"CLASIF. DE PREDIO",CONFIG.defaultValues.clasificacionPredio),await delay(CONFIG.delays.short),await selectByLegend(t,"PREDIO CATASTRAL EN",CONFIG.defaultValues.predioCatastralEn),await delay(CONFIG.delays.short),e["descripcion-zonificacion"]){const o=findInputByLegend(t,"ZONIFICACI");o&&simulateInput(o,e["descripcion-zonificacion"])}if(e["descripcion-area-adquirida"]){const o=findInputByLegend(t,"REA DE TERRENO ADQUIRIDA")||findInputByLegend(t,"AREA DE TERRENO ADQUIRIDA");o&&simulateInput(o,e["descripcion-area-adquirida"])}if(e["descripcion-area-verificada"]){const o=findInputByLegend(t,"REA DE TERRENO VERIFICADA")||findInputByLegend(t,"AREA DE TERRENO VERIFICADA");o&&simulateInput(o,e["descripcion-area-verificada"])}const o=["FRENTE","DERECHA","IZQUIERDA","FONDO"],n=["frente","derecha","izquierda","fondo"],a=t.querySelectorAll('.grid.grid-cols-3, div[class*="grid-cols-3"]');for(let t=0;t<o.length;t++){const i=o[t],c=n[t];for(const t of a){const o=t.querySelector("legend, p");if(o&&o.textContent.trim().toUpperCase().includes(i)){const o=t.querySelectorAll("input");o[0]&&e["lindero-"+c+"-medida"]&&(simulateInput(o[0],e["lindero-"+c+"-medida"]),log("Lindero "+i+" medida seteado","success")),o[1]&&e["lindero-"+c+"-colindancia"]&&(simulateInput(o[1],e["lindero-"+c+"-colindancia"]),log("Lindero "+i+" colindancia seteado","success"));break}}}if(0===a.length)for(let a=0;a<o.length;a++){const i=o[a],c=n[a],l=t.querySelectorAll("*");for(const t of l)if(0===t.children.length&&t.textContent.trim().toUpperCase()===i){const o=t.closest('.grid, tr, .ant-row, div[class*="grid"]');if(o){const t=o.querySelectorAll("input");t[0]&&e["lindero-"+c+"-medida"]&&simulateInput(t[0],e["lindero-"+c+"-medida"]),t[1]&&e["lindero-"+c+"-colindancia"]&&simulateInput(t[1],e["lindero-"+c+"-colindancia"]);break}}}const i=findSearchButtonByLegend(t,"DIGO DE USO")||findSearchButtonByLegend(t,"COD. DE USO");i&&simulateClick(i),log('Seccion 06 completada. Esperando click en "Guardar descripcion del predio"...',"success"),await waitForButtonClick("button","Guardar descripci"),log("Usuario guardo DESCRIPCION","success"),await delay(CONFIG.delays.medium),await expandAndProcessSection(6)}async function handleSeccion07Servicios(){log("Procesando Seccion 07: SERVICIOS BASICOS","info"),await delay(CONFIG.delays.medium);const e=document.querySelectorAll(".ant-collapse-item")[6];if(!e)return;e.querySelectorAll(".ant-select").forEach(e=>{removeReadonly(e)});e.querySelectorAll(".ant-select input").forEach(e=>{e.removeAttribute("readonly")}),log('Seccion 07 - Readonly removido de selectores. Esperando click en "Guardar servicios basicos"...',"success"),await waitForButtonClick("button","Guardar servicios b"),log("Usuario guardo SERVICIOS BASICOS","success"),await delay(CONFIG.delays.medium),await expandAndProcessSection(10)}async function handleSeccion11Inscripcion(){log("Procesando Seccion 11: INSCRIPCION DEL PREDIO","info");const e=AppState.storedData.inscripcion||{};await delay(CONFIG.delays.medium);const t=document.querySelectorAll(".ant-collapse-item")[10];if(t){if(await selectByLegend(t,"TIPO PARTIDA",CONFIG.defaultValues.tipoPartidaRegistral),await delay(CONFIG.delays.short),e["inscripcion-asiento"]){const o=findInputByLegend(t,"ASIENTO");o&&(simulateInput(o,e["inscripcion-asiento"]),log("Asiento seteado","success"))}if(e["inscripcion-fecha"]){const o=e["inscripcion-fecha"];log("Buscando campo de fecha inscripcion...","info");let n=null;const a=t.querySelectorAll(".ant-picker");for(const e of a){const t=e.closest(".ant-form-item, fieldset");if(t){const o=t.querySelector("label, legend");if(o&&o.textContent.toUpperCase().includes("FECHA")){n=e;break}}}if(!n&&a.length>0&&(n=a[0]),n){log("Picker de fecha encontrado, haciendo click para abrir...","info"),simulateClick(n),await delay(CONFIG.delays.medium);const e=n.querySelector("input");if(e){e.focus(),await delay(CONFIG.delays.short);const t=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").set;t.call(e,""),e.dispatchEvent(new Event("input",{bubbles:!0})),await delay(100);for(let n=0;n<o.length;n++){const a=e.value+o[n];t.call(e,a),e.dispatchEvent(new Event("input",{bubbles:!0})),await delay(50)}await delay(CONFIG.delays.medium),e.dispatchEvent(new Event("change",{bubbles:!0})),await delay(CONFIG.delays.short);const n=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});e.dispatchEvent(n),await delay(CONFIG.delays.short),log("Fecha de inscripcion seteada: "+o,"success")}else log("No se encontro el input dentro del picker de fecha","warning")}else log("No se encontro el picker de fecha","warning")}if(e["inscripcion-numero"]){let o=findInputByLegend(t,"NUMERO");o||(o=findInputByLegend(t,"MERO")),o&&(simulateInput(o,e["inscripcion-numero"]),log("Numero de inscripcion seteado","success"))}log("Seccion 11 completada. Iniciando proceso de observaciones y firmas...","success"),await handleSeccionFinal()}}const CONSTRUCCION_MAPPINGS={mep:{0:"00 - NINGUNO","00":"00 - NINGUNO",1:"01 - CONCRETO","01":"01 - CONCRETO",2:"02 - LADRILLO","02":"02 - LADRILLO",3:"03 - ADOBE","03":"03 - ADOBE"},ecs:{0:"00 - NINGUNO","00":"00 - NINGUNO",1:"01 - MUY BUENO","01":"01 - MUY BUENO",2:"02 - BUENO","02":"02 - BUENO",3:"03 - REGULAR","03":"03 - REGULAR",4:"04 - MALO","04":"04 - MALO"},ecc:{0:"00 - NINGUNO","00":"00 - NINGUNO",1:"01 - TERMINADO","01":"01 - TERMINADO",2:"02 - EN CONSTRUCCION","02":"02 - EN CONSTRUCCION",3:"03 - INCONCLUSA","03":"03 - INCONCLUSA",4:"04 - EN RUINAS","04":"04 - EN RUINAS"},uca:{0:"00 - NINGUNO","00":"00 - NINGUNO",1:"01 - EN RETIRO","01":"01 - EN RETIRO",2:"02 - EN JARDIN","02":"02 - EN JARDIN",3:"03 - EN VIA","03":"03 - EN VIA",4:"04 - EN LOTE","04":"04 - EN LOTE",5:"05 - ALTURA","05":"05 - ALTURA",6:"06 - EN PARQUE","06":"06 - EN PARQUE",7:"07 - EN BIEN","07":"07 - EN BIEN"},letras:{0:"00 - NINGUNO","00":"00 - NINGUNO",a:"A",A:"A",b:"B",B:"B",c:"C",C:"C",d:"D",D:"D",e:"E",E:"E",f:"F",F:"F",g:"G",G:"G",h:"H",H:"H",i:"I",I:"I"}};async function selectModalOption(e,t,o){if(!o||""===o.toString().trim())return;log(`Buscando selector para: ${t} con valor: ${o}`,"info");const n=e.querySelectorAll(".ant-form-item");let a=null;for(const e of n){const o=e.querySelector("label");if(o){const n=o.getAttribute("title")||"",i=o.textContent||"";if((n.toUpperCase().includes(t.toUpperCase())||i.toUpperCase().includes(t.toUpperCase()))&&(a=e.querySelector(".ant-select"),a)){log(`Encontrado selector para ${t} en form-item`,"success");break}}}if(!a){const o=e.querySelectorAll(".ant-select");for(const e of o){const o=e.closest(".ant-form-item")||e.parentElement?.parentElement?.parentElement;if(o){if((o.textContent||"").toUpperCase().includes(t.toUpperCase())){a=e,log(`Encontrado selector para ${t} por fallback`,"success");break}}}}if(!a)return void log(`Selector no encontrado para: ${t}`,"warning");await selectOptionByText(a,o,!1)?log(`Seleccionado ${t}: ${o}`,"success"):log(`No se pudo seleccionar ${t}: ${o}`,"warning")}async function selectMesModal(e,t){if(!t||""===t.toString().trim())return;const o=e.querySelectorAll(".ant-form-item");let n=null;for(const e of o){const t=e.querySelector("label");if(t&&t.textContent.includes("FECHA DE CONSTRUCCI")){const t=e.querySelector(".flex.gap-3, .flex");t&&(n=t.querySelector(".ant-select"));break}}if(!n){const t=e.querySelectorAll(".ant-select");for(const e of t){const t=e.querySelector(".ant-select-selection-item");if(t&&"Mes"===t.textContent.trim()){n=e;break}}}if(!n)return void log("Selector de mes no encontrado","warning");const a=t.toString().padStart(2,"0");await selectOptionByText(n,a,!0)}async function setAnioModal(e,t){if(!t||""===t.toString().trim())return;const o=e.querySelector('input[placeholder="A帽o"]');o&&(simulateInput(o,t.toString()),log(`A帽o establecido: ${t}`,"success"))}async function processConstruccionRow(e,t){log(`Procesando construccion fila ${t+1}`,"info");const o=document.querySelectorAll(".ant-collapse-item")[7];if(!o)return void log("Secci贸n 08 no encontrada","error");const n=o.querySelector("button.ant-btn-primary .anticon-plus")?.closest("button")||Array.from(o.querySelectorAll("button")).find(e=>e.textContent.includes("NUEVO"));if(!n)return void log("Bot贸n NUEVO no encontrado en secci贸n 08","error");simulateClick(n),await delay(CONFIG.delays.long);const a=await waitForModal("NUEVA CONSTRUCCI");if(!a)return void log("Modal de nueva construcci贸n no apareci贸","error");if(e.npiso){const t=a.querySelector('input.ant-input[type="text"]');t&&(simulateInput(t,e.npiso),log(`N掳 Piso: ${e.npiso}`,"success"))}if(await selectMesModal(a,e.mes),await setAnioModal(a,e.anio),e.mep){const t=CONSTRUCCION_MAPPINGS.mep[e.mep]||e.mep;await selectModalOption(a,"MATERIAL ESTRUC",t)}if(e.ecs){const t=CONSTRUCCION_MAPPINGS.ecs[e.ecs]||e.ecs;await selectModalOption(a,"ESTADO CONSERV",t)}if(e.ecc){const t=CONSTRUCCION_MAPPINGS.ecc[e.ecc]||e.ecc;await selectModalOption(a,"ESTADO CONSTRUCC",t)}if(e.muro){const t=CONSTRUCCION_MAPPINGS.letras[e.muro]||e.muro.toUpperCase();await selectModalOption(a,"MUROS Y COLUMNAS",t)}if(e.techo){const t=CONSTRUCCION_MAPPINGS.letras[e.techo]||e.techo.toUpperCase();await selectModalOption(a,"TECHOS",t)}if(e.piso){const t=CONSTRUCCION_MAPPINGS.letras[e.piso]||e.piso.toUpperCase();await selectModalOption(a,"PISOS",t)}if(e.puerta){const t=CONSTRUCCION_MAPPINGS.letras[e.puerta]||e.puerta.toUpperCase();await selectModalOption(a,"PUERTAS Y VENTANAS",t)}if(e.revest){const t=CONSTRUCCION_MAPPINGS.letras[e.revest]||e.revest.toUpperCase();await selectModalOption(a,"REVESTIMIENTOS",t)}if(e.banio){const t=CONSTRUCCION_MAPPINGS.letras[e.banio]||e.banio.toUpperCase();await selectModalOption(a,"BAOS",t)}if(e.inst){const t=CONSTRUCCION_MAPPINGS.letras[e.inst]||e.inst.toUpperCase();await selectModalOption(a,"INST. EL",t)}if(e.area){const t=a.querySelector('input[type="number"][maxlength="11"]');t&&(simulateInput(t,e.area),log(`rea: ${e.area}`,"success"))}if(e.uca){const t=CONSTRUCCION_MAPPINGS.uca[e.uca]||e.uca;await selectModalOption(a,"UBI. CONSTRUC",t)}await delay(CONFIG.delays.medium);const i=a.querySelector(".ant-modal-footer button.ant-btn-primary");i&&(simulateClick(i),log(`Construcci贸n fila ${t+1} guardada`,"success")),await delay(CONFIG.delays.extraLong)}async function handleSeccion08Construcciones(e){log("Procesando Seccion 08: CONSTRUCCIONES","info");const t=document.querySelectorAll(".ant-collapse-item")[7];if(t){if(!t.classList.contains("ant-collapse-item-active")){simulateClick(t.querySelector(".ant-collapse-header")),await delay(CONFIG.delays.long)}for(let t=0;t<e.length;t++)await processConstruccionRow(e[t],t),await delay(CONFIG.delays.medium);log("Secci贸n 08 completada","success")}else log("Secci贸n 08 no encontrada","error")}async function processObraRow(e,t){log(`Procesando obra fila ${t+1}`,"info");const o=document.querySelectorAll(".ant-collapse-item")[8];if(!o)return void log("Secci贸n 09 no encontrada","error");const n=o.querySelector("button.ant-btn-primary .anticon-plus")?.closest("button")||Array.from(o.querySelectorAll("button")).find(e=>e.textContent.includes("NUEVO"));if(!n)return void log("Bot贸n NUEVO no encontrado en secci贸n 09","error");simulateClick(n),await delay(CONFIG.delays.long);const a=await waitForModal("NUEVA OBRA COMPLEMENTARIA");if(!a)return void log("Modal de nueva obra no apareci贸","error");const i=a.querySelector("button .anticon-search")?.closest("button");i&&(simulateClick(i),await delay(CONFIG.delays.long));const c=await waitForModal("CDIGOS DE INSTALACIN");if(!c)return void log("Modal de c贸digos no apareci贸","error");const l=c.querySelector("input#form_item_search");if(l&&e.codigo){simulateInput(l,e.codigo),await delay(CONFIG.delays.short);const t=c.querySelector("button.ant-input-search-button");t&&(simulateClick(t),await delay(CONFIG.delays.long))}const r=c.querySelector("p.float-right span.text-black"),s=r?parseInt(r.textContent):0;if(1===s){const e=c.querySelector("button .anticon-select")?.closest("button");e&&(simulateClick(e),log("C贸digo seleccionado autom谩ticamente","success"))}else s>1&&(log(`Se encontraron ${s} registros. Esperando selecci贸n manual...`,"warning"),await waitForModalToClose("CDIGOS DE INSTALACIN"));await delay(CONFIG.delays.long);const u=await waitForModal("NUEVA OBRA COMPLEMENTARIA");if(!u)return;if(await selectMesModal(u,e.mes),await setAnioModal(u,e.anio),e.mep){const t=CONSTRUCCION_MAPPINGS.mep[e.mep]||e.mep;await selectModalOption(u,"MEP",t)}if(e.ecs){const t=CONSTRUCCION_MAPPINGS.ecs[e.ecs]||e.ecs;await selectModalOption(u,"ECS",t)}if(e.ecc){const t=CONSTRUCCION_MAPPINGS.ecc[e.ecc]||e.ecc;await selectModalOption(u,"ECC",t)}if(e.total){const t=u.querySelector('input[type="number"]:not([placeholder])');t&&(simulateInput(t,e.total),log(`Total: ${e.total}`,"success"))}if(e.uca){const t=CONSTRUCCION_MAPPINGS.uca[e.uca]||e.uca;await selectModalOption(u,"UCA",t)}await delay(CONFIG.delays.medium);const d=u.querySelector(".ant-modal-footer button.ant-btn-primary");d&&(simulateClick(d),log(`Obra fila ${t+1} guardada`,"success")),await delay(CONFIG.delays.extraLong)}async function waitForModalToClose(e,t=6e4){const o=Date.now();for(;Date.now()-o<t;){const t=document.querySelectorAll(".ant-modal");let o=!1;for(const n of t){const t=n.querySelector(".ant-modal-title");if(t&&t.textContent.toUpperCase().includes(e.toUpperCase())&&null!==n.offsetParent){o=!0;break}}if(!o)return!0;await delay(500)}return!1}async function handleSeccion09Obras(e){log("Procesando Secci贸n 09: OBRAS COMPLEMENTARIAS","info");const t=document.querySelectorAll(".ant-collapse-item")[8];if(t){if(!t.classList.contains("ant-collapse-item-active")){simulateClick(t.querySelector(".ant-collapse-header")),await delay(CONFIG.delays.long)}for(let t=0;t<e.length;t++)await processObraRow(e[t],t),await delay(CONFIG.delays.medium);log("Secci贸n 09 completada","success")}else log("Secci贸n 09 no encontrada","error")}async function searchAndSelectPersonal(e){const t=await waitForModal("LISTADO DEL PERSONAL");if(!t)return log("Modal de listado de personal no apareci贸","error"),!1;await delay(CONFIG.delays.medium);const o=t.querySelector("input#form_item_search")||t.querySelector('input[placeholder="Buscar"]');if(o&&e){o.focus(),o.value="",o.dispatchEvent(new Event("input",{bubbles:!0})),await delay(CONFIG.delays.short),simulateInput(o,e),await delay(CONFIG.delays.short);const n=t.querySelector('button[type="submit"]')||t.querySelector("button .anticon-search")?.closest("button");if(n)log("Click en boton de busqueda del modal","info"),simulateClick(n);else{const e=t.querySelectorAll("button");for(const t of e)if(t.textContent.includes("BUSCAR")){log("Click en boton BUSCAR del modal","info"),simulateClick(t);break}}await delay(CONFIG.delays.long),await delay(CONFIG.delays.long)}const n=t.querySelector("p.float-right span.text-black"),a=n?parseInt(n.textContent):0;if(log(`Total de registros encontrados: ${a}`,"info"),1===a){const e=t.querySelector("button .anticon-select")?.closest("button");if(e)return await delay(CONFIG.delays.short),simulateClick(e),log("Personal seleccionado automaticamente","success"),await delay(CONFIG.delays.medium),!0}else{if(a>1)return log(`Se encontraron ${a} registros. Esperando seleccion manual...`,"warning"),await waitForModalToClose("LISTADO DEL PERSONAL"),!0;{log("No se encontraron registros","warning");const e=t.querySelector(".ant-modal-close");e&&simulateClick(e)}}return!1}async function setFechaFirmaModal(e,t){if(!t)return;const o=t;log(`Estableciendo fecha: ${o}`,"info");const n=e.querySelector("input#form_item_fecharegistro")||e.querySelector('input[placeholder*="DD"]')||e.querySelector(".ant-picker input");if(!n)return void log("Input de fecha no encontrado","warning");n.focus(),await delay(CONFIG.delays.short),n.value="",n.dispatchEvent(new Event("input",{bubbles:!0})),await delay(100),simulateEnter(n);for(let e=0;e<o.length;e++)n.value+=o[e],n.dispatchEvent(new Event("input",{bubbles:!0})),await delay(30);n.dispatchEvent(new Event("change",{bubbles:!0})),n.dispatchEvent(new Event("blur",{bubbles:!0})),simulateEnter(n),await delay(CONFIG.delays.short);const a=e.querySelector(".ant-modal-body");a&&simulateClick(a),await delay(CONFIG.delays.short),log(`Fecha establecida: ${o}`,"success")}async function processFirmaSupervisor(e){log("Procesando firma del supervisor","info");let t=null;const o=document.querySelectorAll("span");for(const e of o)if("[95] FIRMA DEL SUPERVISOR"===e.textContent.trim()){const o=e.closest(".flex");if(o&&(t=o.querySelector("button .anticon-edit")?.closest("button"),t)){log("Bot贸n de editar supervisor encontrado","success");break}}if(!t){const e=document.querySelectorAll(".flex.justify-between");for(const o of e)if(o.textContent.includes("[95]")&&o.textContent.includes("SUPERVISOR")&&(t=o.querySelector("button .anticon-edit")?.closest("button"),t))break}if(!t)return void log("Bot贸n de editar supervisor no encontrado","warning");simulateClick(t),await delay(CONFIG.delays.long);let n=await waitForModal("FIRMA DEL SUPERVISOR");if(n||(n=await waitForModal("NUEVA FIRMA")),!n)return void log("Modal de firma supervisor no apareci贸","error");const a=n.querySelector("legend button .anticon-search")?.closest("button")||n.querySelector("button .anticon-search")?.closest("button");a&&(simulateClick(a),await delay(CONFIG.delays.long),await searchAndSelectPersonal(e["final-supervisor-nombre"])),await delay(CONFIG.delays.long);let i=await waitForModal("FIRMA DEL SUPERVISOR");if(i||(i=await waitForModal("NUEVA FIRMA")),i){await setFechaFirmaModal(i,e["final-supervisor-fecha"]),await delay(CONFIG.delays.medium);const t=i.querySelector(".ant-modal-footer button.ant-btn-primary");t&&(simulateClick(t),log("Firma supervisor guardada","success"))}await delay(CONFIG.delays.extraLong)}async function processFirmaTecnico(e){log("Procesando firma del t茅cnico catastral","info");let t=null;const o=document.querySelectorAll("span");for(const e of o){const o=e.textContent.trim();if(o.includes("[96]")&&o.includes("FIRMA")&&o.includes("CNICO")){const o=e.closest(".flex");if(o&&(t=o.querySelector("button .anticon-edit")?.closest("button"),t)){log("Bot贸n de editar t茅cnico encontrado","success");break}}}if(!t){const e=document.querySelectorAll(".flex.justify-between");for(const o of e)if(o.textContent.includes("[96]")&&o.textContent.includes("CNICO")&&(t=o.querySelector("button .anticon-edit")?.closest("button"),t))break}if(!t)return void log("Bot贸n de editar t茅cnico no encontrado","warning");simulateClick(t),await delay(CONFIG.delays.long);let n=await waitForModal("CNICO CATASTRAL");if(n||(n=await waitForModal("NUEVA FIRMA")),!n)return void log("Modal de firma t茅cnico no apareci贸","error");const a=n.querySelector("legend button .anticon-search")?.closest("button")||n.querySelector("button .anticon-search")?.closest("button");a&&(simulateClick(a),await delay(CONFIG.delays.long),await searchAndSelectPersonal(e["final-tecnico-nombre"])),await delay(CONFIG.delays.long);let i=await waitForModal("CNICO CATASTRAL");if(i||(i=await waitForModal("NUEVA FIRMA")),i){await setFechaFirmaModal(i,e["final-tecnico-fecha"]),await delay(CONFIG.delays.medium);const t=i.querySelector(".ant-modal-footer button.ant-btn-primary");t&&(simulateClick(t),log("Firma t茅cnico guardada","success"))}await delay(CONFIG.delays.extraLong)}async function handleSeccionFinal(){log("Procesando seccion final: FIRMAS","info");const e=AppState.storedData.final||{};log('Esperando click en boton "Guardar observaciones"...',"info"),await waitForObservacionesButtonClick(),log("Usuario guardo observaciones","success"),await delay(CONFIG.delays.long),e["final-supervisor-nombre"]&&await processFirmaSupervisor(e),await delay(CONFIG.delays.long),e["final-tecnico-nombre"]&&await processFirmaTecnico(e),log("Seccion final completada","success")}function waitForObservacionesButtonClick(){return new Promise(e=>{log("Configurando listener para boton Guardar observaciones...","info");const t=o=>{const n=o.target.closest("button");if(!n)return;(n.textContent||"").includes("Guardar observaciones")&&(log("Click detectado en Guardar observaciones!","success"),document.removeEventListener("click",t,!0),e(n))};document.addEventListener("click",t,!0);document.addEventListener("mousedown",e=>{const t=e.target.closest("button");if(!t)return;(t.textContent||"").includes("Guardar observaciones")&&log("MouseDown detectado en Guardar observaciones!","success")},!0)})}async function expandAndProcessSection(e){if(!AppState.licenseValid)return void log("Licencia no v谩lida. Deteniendo automatizaci贸n.","error");const t=document.querySelectorAll(".ant-collapse-item");if(e>=t.length)return void log("Todas las secciones procesadas","success");const o=t[e],n=o.querySelector(".ant-collapse-header");o.classList.contains("ant-collapse-item-active")||(simulateClick(n),await waitForSectionToExpand(e));const a={0:handleSeccion01Principales,1:handleSeccion02Ubicacion,2:handleSeccion03Titular,3:handleSeccion04Domicilio,4:handleSeccion05Caracteristicas,5:handleSeccion06Descripcion,6:handleSeccion07Servicios,10:handleSeccion11Inscripcion}[e];a&&await a()}async function init(){log("Verificando licencia antes de iniciar...","info");if(!await verifyLicenseForContentScript())return void log("Automatizaci贸n detenida: Licencia no v谩lida","error");log("Iniciando automatizacion de Ficha Catastral Individual","info"),AppState.storedData=await getStoredData(),log("Datos cargados del storage","success"),document.addEventListener("keydown",e=>{"Tab"===e.key&&simulateEnter(e.target)}),await delay(CONFIG.delays.extraLong);const e=document.querySelector(".ant-collapse-item");e&&e.classList.contains("ant-collapse-item-active")?(log("Seccion 01 detectada como activa","info"),await handleSeccion01Principales()):(await waitForSectionToExpand(0),await handleSeccion01Principales())}chrome.runtime.onMessage.addListener((e,t,o)=>AppState.licenseValid?"executeSection"===e.action?(log(`Recibida solicitud de ejecuci贸n: ${e.section}`,"info"),"construcciones"===e.section?handleSeccion08Construcciones(e.data).then(()=>{o({success:!0})}).catch(e=>{log(`Error en construcciones: ${e.message}`,"error"),o({success:!1,error:e.message})}):"obras"===e.section&&handleSeccion09Obras(e.data).then(()=>{o({success:!0})}).catch(e=>{log(`Error en obras: ${e.message}`,"error"),o({success:!1,error:e.message})}),!0):void 0:(o({success:!1,error:"Licencia no v谩lida"}),!0)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init();