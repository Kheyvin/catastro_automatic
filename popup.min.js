// @ts-nocheck
const STORAGE_KEY="fichaCatastralData",THEME_KEY="fichaCatastralTheme",SECCIONES_CONFIG={principales:{fields:["principales-sector","principales-manzana","principales-lote"]},ubicacion:{fields:["ubicacion-codigo-via","ubicacion-codigo-hu","ubicacion-n-municipal","ubicacion-manzana","ubicacion-lote","ubicacion-sub-lote"]},descripcion:{fields:["descripcion-zonificacion","descripcion-area-adquirida","descripcion-area-verificada","lindero-frente-medida","lindero-frente-colindancia","lindero-derecha-medida","lindero-derecha-colindancia","lindero-izquierda-medida","lindero-izquierda-colindancia","lindero-fondo-medida","lindero-fondo-colindancia"]},inscripcion:{fields:["inscripcion-numero","inscripcion-asiento","inscripcion-fecha"]},final:{fields:["final-observaciones","final-supervisor-nombre","final-supervisor-fecha","final-tecnico-nombre","final-tecnico-fecha"]}},TABLAS_CONFIG={construcciones:{tableId:"tabla-construcciones",tbodyId:"tbody-construcciones",columns:["npiso","mes","anio","mep","ecs","ecc","muro","techo","piso","puerta","revest","banio","inst","area","uca"]},obras:{tableId:"tabla-obras",tbodyId:"tbody-obras",columns:["codigo","mes","anio","mep","ecs","ecc","total","uca"]}};async function checkLicenseBeforeLoad(){document.querySelector(".container").innerHTML='\n    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; gap: 20px;">\n      <div style="width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite;"></div>\n      <p style="color: #64748b; font-size: 14px;">Verificando licencia...</p>\n    </div>\n    <style>\n      @keyframes spin {\n        to { transform: rotate(360deg); }\n      }\n    </style>\n  ';try{const e=await LicenseManager.verifyLicense();return e.valid?(await loadMainContent(),!0):(showLicenseError(e),!1)}catch(e){return console.error("[Popup] Error verificando licencia:",e),showLicenseError({message:"Error al verificar licencia. Por favor intente nuevamente."}),!1}}function showLicenseError(e){const t=document.querySelector(".container");let n=e.message||"Licencia no v√°lida",o="";e.notFound?o=`\n      <p style="margin-top: 15px; font-size: 12px; color: #64748b;">\n        Licencia no encontrada.<br>\n        Por favor contacte al <strong>üì± ${LICENSE_CONFIG.SUPPORT_PHONE}</strong>\n      </p>\n    `:e.expired?o=`\n      <p style="margin-top: 10px; font-size: 12px; color: #dc2626;">\n        Expir√≥ el: ${LicenseManager.formatExpirationDate(e.expira_en)}\n      </p>\n      <p style="margin-top: 10px; font-size: 12px; color: #64748b;">\n        Para renovar contacte al <strong>üì± ${LICENSE_CONFIG.SUPPORT_PHONE}</strong>\n      </p>\n    `:e.needsActivation&&(o='\n      <p style="margin-top: 15px; font-size: 12px; color: #64748b;">\n        Por favor active su licencia para continuar.\n      </p>\n    '),t.innerHTML=`\n    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; padding: 30px; text-align: center;">\n      <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>\n      <h2 style="color: #dc2626; font-size: 18px; margin-bottom: 10px;">Licencia Requerida</h2>\n      <p style="color: #64748b; font-size: 13px;">${n}</p>\n      ${o}\n      <button id="btn-open-license" style="\n        margin-top: 25px;\n        padding: 12px 24px;\n        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);\n        color: white;\n        border: none;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n      ">\n        üîê Activar Licencia\n      </button>\n      <a href="https://wa.me/51${LICENSE_CONFIG.SUPPORT_PHONE}" target="_blank" style="\n        margin-top: 15px;\n        color: #16a34a;\n        font-size: 12px;\n        text-decoration: none;\n      ">\n        üí¨ Contactar soporte v√≠a WhatsApp\n      </a>\n    </div>\n  `,document.getElementById("btn-open-license").addEventListener("click",()=>{chrome.tabs.create({url:"license.html"})})}async function loadMainContent(){const e=await fetch("popup-content.html"),t=await e.text();document.querySelector(".container").innerHTML=t,initTheme(),loadStoredData(),setupEventListeners(),showLicenseIndicator()}async function showLicenseIndicator(){const e=await LicenseManager.getSavedLicenseData();if(e.data&&e.data.expira_en){const t=LicenseManager.getDaysRemaining(e.data.expira_en),n=document.querySelector(".main-header");if(n){const o=document.createElement("div");o.className="license-indicator",o.style.cssText=`\n        font-size: 9px;\n        padding: 3px 8px;\n        border-radius: 10px;\n        cursor: pointer;\n        ${t<=7?"background: #fef2f2; color: #dc2626;":t<=30?"background: #fef3c7; color: #92400e;":"background: #dcfce7; color: #166534;"}\n      `,o.textContent=`üìã ${t} d√≠as`,o.title=`Licencia v√°lida hasta: ${LicenseManager.formatExpirationDate(e.data.expira_en)}`,o.addEventListener("click",()=>{chrome.tabs.create({url:"license.html"})}),n.insertBefore(o,n.querySelector(".btn-theme"))}}}function showToast(e,t="info"){const n=document.querySelector(".toast");n&&n.remove();const o=document.createElement("div");o.className=`toast ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>o.remove(),300)},2e3)}function generateRowId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function initTheme(){chrome.storage.local.get([THEME_KEY],e=>{if("dark"===e[THEME_KEY]){document.body.classList.add("dark-mode");const e=document.getElementById("btn-theme");e&&(e.textContent="‚òÄÔ∏è")}})}function toggleTheme(){const e=document.body.classList.toggle("dark-mode"),t=document.getElementById("btn-theme");t&&(t.textContent=e?"‚òÄÔ∏è":"üåô"),chrome.storage.local.set({[THEME_KEY]:e?"dark":"light"}),showToast(e?"Modo oscuro activado":"Modo claro activado","info")}async function getAllStoredData(){return new Promise(e=>{chrome.storage.local.get([STORAGE_KEY],t=>{e(t[STORAGE_KEY]||{})})})}async function saveAllData(e){return new Promise(t=>{chrome.storage.local.set({[STORAGE_KEY]:e},t)})}async function getSectionData(e){return(await getAllStoredData())[e]||{}}async function saveSectionData(e,t){const n=await getAllStoredData();n[e]=t,await saveAllData(n)}function getSectionValuesFromDOM(e){const t=SECCIONES_CONFIG[e];if(!t)return{};const n={};return t.fields.forEach(e=>{const t=document.getElementById(e);t&&(n[e]=t.value)}),n}function setSectionValuesInDOM(e,t){const n=SECCIONES_CONFIG[e];n&&n.fields.forEach(e=>{const n=document.getElementById(e);n&&void 0!==t[e]&&(n.value=t[e])})}function clearSectionInDOM(e){const t=SECCIONES_CONFIG[e];t&&t.fields.forEach(e=>{const t=document.getElementById(e);t&&(t.value="")})}async function saveSection(e){const t=getSectionValuesFromDOM(e);await saveSectionData(e,t),showToast(`"${e}" guardado`,"success")}async function clearSection(e){clearSectionInDOM(e),await saveSectionData(e,{}),showToast(`"${e}" limpiado`,"info")}function createTableRow(e,t={}){const n=TABLAS_CONFIG[e];if(!n)return null;const o=document.createElement("tr"),a=t.rowId||generateRowId();o.setAttribute("data-row-id",a),n.columns.forEach(e=>{const n=document.createElement("td"),a=document.createElement("input");a.type="text",a.name=e,a.value=t[e]||"",n.appendChild(a),o.appendChild(n)});const c=document.createElement("td");return c.className="acciones-cell",c.innerHTML='\n    <button class="btn-row btn-duplicate" data-action="duplicate">üìã</button>\n    <button class="btn-row btn-delete" data-action="delete">‚ùå</button>\n  ',o.appendChild(c),o}function getTableDataFromDOM(e){const t=TABLAS_CONFIG[e];if(!t)return[];const n=document.getElementById(t.tbodyId);if(!n)return[];const o=n.querySelectorAll("tr"),a=[];return o.forEach(e=>{const n={rowId:e.getAttribute("data-row-id")};t.columns.forEach(t=>{const o=e.querySelector(`input[name="${t}"]`);o&&(n[t]=o.value)}),a.push(n)}),a}function setTableDataInDOM(e,t){const n=TABLAS_CONFIG[e];if(!n)return;const o=document.getElementById(n.tbodyId);o&&(o.innerHTML="",t&&t.length>0?t.forEach(t=>{const n=createTableRow(e,t);o.appendChild(n)}):o.appendChild(createTableRow(e)))}function clearTableInDOM(e){const t=TABLAS_CONFIG[e];if(!t)return;const n=document.getElementById(t.tbodyId);n&&(n.innerHTML="",n.appendChild(createTableRow(e)))}function addTableRow(e){const t=TABLAS_CONFIG[e];if(!t)return;const n=document.getElementById(t.tbodyId);if(!n)return;const o=createTableRow(e);n.appendChild(o),o.querySelector("input").focus()}function duplicateTableRow(e,t){const n=TABLAS_CONFIG[t];if(!n)return;const o={};n.columns.forEach(t=>{const n=e.querySelector(`input[name="${t}"]`);n&&(o[t]=n.value)});const a=createTableRow(t,o);e.parentNode.insertBefore(a,e.nextSibling),showToast("Fila duplicada","success")}function deleteTableRow(e,t){const n=TABLAS_CONFIG[t];if(!n)return;const o=document.getElementById(n.tbodyId);o&&(o.querySelectorAll("tr").length<=1?showToast("No se puede eliminar la √∫ltima fila","error"):(e.remove(),showToast("Fila eliminada","info")))}async function saveTable(e){const t=getTableDataFromDOM(e);await saveSectionData(e,t),showToast(`"${e}" guardado`,"success")}async function clearTable(e){clearTableInDOM(e),await saveSectionData(e,[]),showToast(`"${e}" limpiado`,"info")}async function executeAutomation(e){const t=getTableDataFromDOM(e).filter(t=>TABLAS_CONFIG[e].columns.some(e=>t[e]&&""!==t[e].trim()));0!==t.length?(await saveSectionData(e,t),showToast(`Ejecutando ${e} (${t.length} filas)...`,"info"),chrome.tabs.query({active:!0,currentWindow:!0},n=>{n[0]&&chrome.tabs.sendMessage(n[0].id,{action:"executeSection",section:e,data:t},e=>{chrome.runtime.lastError?showToast("Error: No se pudo conectar con la p√°gina","error"):e&&e.success&&showToast("Automatizaci√≥n terminada","success")})})):showToast("No hay datos para ejecutar","error")}async function saveAll(){const e={};for(const t of Object.keys(SECCIONES_CONFIG))e[t]=getSectionValuesFromDOM(t);for(const t of Object.keys(TABLAS_CONFIG))e[t]=getTableDataFromDOM(t);await saveAllData(e),showToast("Todo guardado correctamente","success")}async function clearAll(){if(confirm("¬øLimpiar todos los datos?")){for(const e of Object.keys(SECCIONES_CONFIG))clearSectionInDOM(e);for(const e of Object.keys(TABLAS_CONFIG))clearTableInDOM(e);await saveAllData({}),showToast("Todo limpiado","info")}}async function exportData(){const e={};for(const t of Object.keys(SECCIONES_CONFIG))e[t]=getSectionValuesFromDOM(t);for(const t of Object.keys(TABLAS_CONFIG))e[t]=getTableDataFromDOM(t);const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`ficha_catastral_${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),showToast("Datos exportados","success")}async function importData(e){try{const t=await e.text(),n=JSON.parse(t);for(const e of Object.keys(SECCIONES_CONFIG))n[e]&&setSectionValuesInDOM(e,n[e]);for(const e of Object.keys(TABLAS_CONFIG))n[e]&&setTableDataInDOM(e,n[e]);await saveAllData(n),showToast("Datos importados","success")}catch(e){console.error("Error al importar:",e),showToast("Error al importar","error")}}async function loadStoredData(){const e=await getAllStoredData();for(const t of Object.keys(SECCIONES_CONFIG))e[t]&&setSectionValuesInDOM(t,e[t]);for(const t of Object.keys(TABLAS_CONFIG))e[t]&&e[t].length>0&&setTableDataInDOM(t,e[t])}function setupEventListeners(){const e=document.getElementById("btn-theme");e&&e.addEventListener("click",toggleTheme),document.addEventListener("click",async e=>{const t=e.target.closest("button");if(!t)return;const n=t.dataset.action,o=t.dataset.section;if("save"===n&&SECCIONES_CONFIG[o])await saveSection(o);else if("clear"===n&&SECCIONES_CONFIG[o])await clearSection(o);else if("save"===n&&TABLAS_CONFIG[o])await saveTable(o);else if("clear"===n&&TABLAS_CONFIG[o])await clearTable(o);else if("add-row"===n&&TABLAS_CONFIG[o])addTableRow(o);else if("duplicate"===n){duplicateTableRow(t.closest("tr"),t.closest("table").id.replace("tabla-",""))}else if("delete"===n){deleteTableRow(t.closest("tr"),t.closest("table").id.replace("tabla-",""))}else"execute"===n&&TABLAS_CONFIG[o]&&await executeAutomation(o)});const t=document.getElementById("btn-guardar-todo");t&&t.addEventListener("click",saveAll);const n=document.getElementById("btn-limpiar-todo");n&&n.addEventListener("click",clearAll);const o=document.getElementById("btn-exportar");o&&o.addEventListener("click",exportData);const a=document.getElementById("btn-importar");a&&a.addEventListener("click",()=>{document.getElementById("input-importar").click()});const c=document.getElementById("input-importar");c&&c.addEventListener("change",e=>{e.target.files.length>0&&(importData(e.target.files[0]),e.target.value="")})}document.addEventListener("DOMContentLoaded",()=>{checkLicenseBeforeLoad()}),window.FichaCatastralAPI={STORAGE_KEY:STORAGE_KEY,SECCIONES_CONFIG:SECCIONES_CONFIG,TABLAS_CONFIG:TABLAS_CONFIG,getAllData:getAllStoredData,getSectionData:getSectionData,saveSectionData:saveSectionData};