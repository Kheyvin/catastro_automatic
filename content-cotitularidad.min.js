// @ts-nocheck
const STORAGE_KEY="fichaCatastralData",CONFIG={delays:{short:100,medium:300,long:500,extraLong:1e3},selectors:{sectionHeader:".ant-collapse-header",sectionContent:".ant-collapse-content",sectionActive:".ant-collapse-item-active",selectDropdown:".ant-select-dropdown",selectItem:".ant-select-item-option",selectItemContent:".ant-select-item-option-content",modalRoot:".ant-modal-root",modalBody:".ant-modal-body",modalTitle:".ant-modal-title",tableRow:".ant-table-row",paginationTotal:".float-right.font-semibold span.text-black",inputSearch:'input[placeholder="Buscar"]',searchButton:".ant-input-search-button"},defaultValues:{provinciaDefault:"TACNA",distritoDefault:"CORONEL GREGORIO ALBARRACIN LANCHIPA"}},FIELD_MAP={codeVia:{label:"[05]",keyword:"VA"},tipoVia:{label:"[06]",keyword:"TIPO"},nombreVia:{label:"[07]",keyword:"NOMBRE"},numberMunicipal:{label:"[09]",keyword:"MUNICIPAL"},numberInterior:{label:"[13]",keyword:"INTERIOR"},codeHu:{label:"[14]",keyword:"CDIGO"},nombreHu:{label:"[15]",keyword:"NOMBRE"},zonaSector:{label:"[16]",keyword:"ZONA"},numberManzana:{label:"[17]",keyword:"MANZANA"},numberLote:{label:"[18]",keyword:"LOTE"},numberSubLote:{label:"[19]",keyword:"SUB"},telefono:{label:"[34]",keyword:"TELFONO"},anexo:{label:"[35]",keyword:"ANEXO"},email:{label:"[36]",keyword:"CORREO"},observations:{selector:"#form_item_observacion"},supervisorName:{selector:"#form_item_supervisornombre"},technicianName:{selector:"#form_item_tecniconombre"},supervisorDate:{isModal:!0,modalTitle:"SUPERVISOR",selector:"#form_item_fecharegistro",isDate:!0},technicianDate:{isModal:!0,modalTitle:"TCNICO",selector:"#form_item_fecharegistro",isDate:!0}},CotitularidadState={licenseValid:!1,storedData:null,isProcessing:!1};function delay(e){return new Promise(t=>setTimeout(t,e))}function log(e,t="info"){const n={info:"color: #3b82f6",success:"color: #22c55e",error:"color: #ef4444",warning:"color: #f59e0b"};console.log("%c[FichaCatastral-Cotitularidad] "+e,n[t]||n.info)}function simulateInput(e,t){if(e){try{let n;e instanceof HTMLInputElement?n=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value").set:e instanceof HTMLTextAreaElement&&(n=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value").set),n?n.call(e,t):e.value=t}catch(n){e.value=t}e.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new Event("change",{bubbles:!0,cancelable:!0})),e.dispatchEvent(new FocusEvent("focus",{bubbles:!0})),e.dispatchEvent(new FocusEvent("blur",{bubbles:!0}))}}function simulateClick(e){if(!e)return!1;const t={bubbles:!0,cancelable:!0,view:window,button:0,buttons:1,clientX:e.getBoundingClientRect?e.getBoundingClientRect().x+5:0,clientY:e.getBoundingClientRect?e.getBoundingClientRect().y+5:0};return e.focus&&e.focus(),e.dispatchEvent(new MouseEvent("mousedown",t)),e.dispatchEvent(new MouseEvent("mouseup",t)),e.dispatchEvent(new MouseEvent("click",t)),!0}function simulateEnter(e){if(!e)return;const t=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0});e.dispatchEvent(t);const n=new KeyboardEvent("keyup",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0});e.dispatchEvent(n)}async function getStoredData(){return new Promise(e=>{chrome.storage.local.get([STORAGE_KEY],t=>{e(t[STORAGE_KEY]||{})})})}async function openSelector(e){if(!e)return log("Selector no encontrado","error"),null;const t=e.closest(".ant-select")||e;if(t.classList.contains("ant-select-disabled"))return log("El selector est谩 deshabilitado","warning"),null;const n=t.querySelector(".ant-select-selector"),o=async()=>{n?(n.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),await delay(100),n.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window})),await delay(100),n.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))):simulateClick(t)};await o(),await delay(CONFIG.delays.medium);let a=null;for(let e=0;e<20;e++){const t=document.querySelectorAll(".ant-select-dropdown");for(const e of t)try{const t=window.getComputedStyle(e);if(!(e.classList.contains("ant-select-dropdown-hidden")||"none"===t.display||"none"===e.style.display||"hidden"===t.visibility)&&null!==e.offsetParent){a=e;break}}catch(e){continue}if(a)break;5===e&&await o(),await delay(150)}return a?(await delay(100),a):(log("No se pudo abrir el dropdown del selector","error"),null)}async function selectOptionByText(e,t,n=!1){const o=await openSelector(e);if(!o)return!1;const a=e=>e.trim().toUpperCase().replace(/\s+/g," ").normalize("NFD").replace(/[\u0300-\u036f]/g,""),i=a(t),l=i.split(" - ")[0].replace(/^0+/,""),c=()=>{const e=o.querySelectorAll(".ant-select-item-option:not(.ant-select-item-option-disabled)");for(const t of e){const e=t.querySelector(".ant-select-item-option-content"),o=e?e.textContent.trim():t.textContent.trim(),c=a(o),r=c.split(" - ")[0].replace(/^0+/,"");if(n){if(c===i)return t}else{if(c===i)return t;if(l&&r&&l===r)return t;if(i.length>1&&(c.includes(i)||i.includes(c)))return t}}return null},r=o.querySelector(".rc-virtual-list-holder"),s=e.querySelector("input")||e.closest(".ant-select")?.querySelector("input");let u=0;for(;u<100;){const e=c();if(e)return simulateClick(e),await delay(CONFIG.delays.short),log("Opcion seleccionada: "+t,"success"),!0;if(s){const e=new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown",keyCode:40,which:40,bubbles:!0,cancelable:!0});s.dispatchEvent(e)}if(r){const e=r.querySelector(".rc-virtual-list-holder-inner")?.parentElement||r;e.scrollTop+=200,e.dispatchEvent(new Event("scroll",{bubbles:!0}))}await delay(80),u++}return simulateClick(document.body),await delay(CONFIG.delays.short),log("No se encontro la opcion: "+t,"warning"),!1}async function selectByLegend(e,t,n,o=!1){const a=e.querySelectorAll("fieldset");for(const e of a){const a=e.querySelector("legend, label, p, h1");if(a&&a.textContent.includes(t)){const t=e.querySelector(".ant-select");if(t)return await selectOptionByText(t,n,o)}}const i=e.querySelectorAll(".ant-form-item");for(const e of i){const a=e.querySelector(".ant-form-item-label label, .ant-form-item-label, label");if(a&&a.textContent.includes(t)){const t=e.querySelector(".ant-select");if(t)return await selectOptionByText(t,n,o)}}return log("No se encontro selector para: "+t,"warning"),!1}function findInputByLegend(e,t){const n=t.toUpperCase(),o=e.querySelectorAll("fieldset");for(const e of o){const t=e.querySelector("legend");if(t&&t.textContent.toUpperCase().includes(n)){const t=e.querySelector('input:not([role="combobox"]):not([type="search"])');if(t)return t}}const a=e.querySelectorAll(".ant-form-item");for(const e of a){const t=e.querySelector(".ant-form-item-label label, label, legend");if(t&&t.textContent.toUpperCase().includes(n)){const t=e.querySelector('input:not([role="combobox"]):not([type="search"])');if(t)return t}}const i=e.querySelectorAll("label, legend, p, h1, h2, h3, span");for(const e of i)if(e.textContent.toUpperCase().includes(n)){const t=e.closest('fieldset, .ant-form-item, .ant-col, .ant-row, div[class*="flex"]');if(t){const e=t.querySelector('input:not([role="combobox"]):not([type="search"])');if(e)return e}}return null}function findSearchButtonByLegend(e,t){const n=t.toUpperCase(),o=e.querySelectorAll("fieldset");for(const e of o){const t=e.querySelector("legend");if(t&&t.textContent.toUpperCase().includes(n)){const t=e.querySelector("button .anticon-search")?.closest("button")||e.querySelector(".ant-input-search-button");if(t)return t}}const a=e.querySelectorAll("label, legend, p, h1, h2, h3, span");for(const e of a)if(e.textContent.toUpperCase().includes(n)){const t=e.closest('fieldset, .ant-form-item, .ant-col, .ant-row, div[class*="flex"]');if(t){const e=t.querySelector("button .anticon-search")?.closest("button")||t.querySelector(".ant-input-search-button");if(e)return e}}return null}async function waitForModal(e,t=1e4){return new Promise((n,o)=>{let a;const i=setTimeout(()=>{a&&a.disconnect(),n(null)},t),l=()=>{try{const t=document.querySelectorAll(".ant-modal");for(const n of t){const t=n.querySelector(".ant-modal-title");if(t&&t.textContent&&t.textContent.toUpperCase().includes(e.toUpperCase()))try{if(null!==n.offsetParent||"none"!==n.style.display)return n}catch(e){continue}}}catch(e){return null}return null},c=l();if(c)return clearTimeout(i),setTimeout(()=>n(c),CONFIG.delays.medium);a=new MutationObserver(()=>{const e=l();e&&(clearTimeout(i),a.disconnect(),setTimeout(()=>n(e),CONFIG.delays.medium))}),a.observe(document.body,{childList:!0,subtree:!0})})}async function searchInModal(e,t){const n=e.querySelector('input[placeholder="Buscar"]');if(!n)return log("Input de busqueda no encontrado en modal","error"),!1;n.value="",simulateInput(n,t),await delay(CONFIG.delays.medium);const o=e.querySelector(".ant-input-search-button");return o&&(simulateClick(o),await delay(CONFIG.delays.long)),!0}async function handleModalSearch(e,t,n=!0){try{const o=await waitForModal(e);if(!o)return log("Modal no encontrado: "+e,"error"),!1;await searchInModal(o,t),await delay(CONFIG.delays.long);const a=o.querySelector("p.float-right span.text-black"),i=a?parseInt(a.textContent):0;if(1===i&&n){const e=o.querySelector("button .anticon-select")?.closest("button");if(e)return simulateClick(e),log("Registro seleccionado automaticamente","success"),await delay(CONFIG.delays.medium),!0}else if(i>1)return log(`Se encontraron ${i} registros. Esperando seleccion manual...`,"warning"),await waitForModalToClose(e),!0;return!1}catch(e){return log("Error en busqueda de modal: "+e.message,"error"),!1}}function waitForModalToClose(e){return new Promise(t=>{const n=setInterval(()=>{const o=document.querySelectorAll(".ant-modal");let a=!1;for(const t of o){const n=t.querySelector(".ant-modal-title");if(n&&n.textContent.includes(e)&&null!==t.offsetParent){a=!0;break}}a||(clearInterval(n),t())},500);setTimeout(()=>{clearInterval(n),t()},6e4)})}async function searchAndSelectPersonal(e){if(!e)return!1;const t=await waitForModal("LISTADO DEL PERSONAL");if(!t)return log("Modal de personal no apareci贸","error"),!1;const n=t.querySelector('input[placeholder="Buscar"]');if(n&&e){n.focus(),n.value="",n.dispatchEvent(new Event("input",{bubbles:!0})),await delay(CONFIG.delays.short),simulateInput(n,e),await delay(CONFIG.delays.short);const o=t.querySelector('button[type="submit"]')||t.querySelector("button .anticon-search")?.closest("button");if(o)log("Click en boton de busqueda del modal","info"),simulateClick(o);else{const e=t.querySelectorAll("button");for(const t of e)if(t.textContent.includes("BUSCAR")){log("Click en boton BUSCAR del modal","info"),simulateClick(t);break}}await delay(CONFIG.delays.long),await delay(CONFIG.delays.long)}const o=t.querySelector("p.float-right span.text-black"),a=o?parseInt(o.textContent):0;if(log(`Total de registros encontrados: ${a}`,"info"),1===a){const e=t.querySelector("button .anticon-select")?.closest("button");if(e)return await delay(CONFIG.delays.short),simulateClick(e),log("Personal seleccionado automaticamente","success"),await delay(CONFIG.delays.medium),!0}else{if(a>1)return log(`Se encontraron ${a} registros. Esperando seleccion manual...`,"warning"),await waitForModalToClose("LISTADO DEL PERSONAL"),!0;{log("No se encontraron registros","warning");const e=t.querySelector(".ant-modal-close");e&&simulateClick(e)}}return!1}async function setFechaFirmaModal(e,t){if(!t)return;const n=t;log(`Estableciendo fecha: ${n}`,"info");const o=e.querySelector("input#form_item_fecharegistro")||e.querySelector('input[placeholder*="DD"]')||e.querySelector(".ant-picker input");if(!o)return void log("Input de fecha no encontrado","warning");o.focus(),await delay(CONFIG.delays.short),o.value="",o.dispatchEvent(new Event("input",{bubbles:!0})),await delay(100),simulateEnter(o);for(let e=0;e<n.length;e++)o.value+=n[e],o.dispatchEvent(new Event("input",{bubbles:!0})),await delay(30);o.dispatchEvent(new Event("change",{bubbles:!0})),o.dispatchEvent(new Event("blur",{bubbles:!0})),simulateEnter(o),await delay(CONFIG.delays.short);const a=e.querySelector(".ant-modal-body");a&&simulateClick(a),await delay(CONFIG.delays.short),log(`Fecha establecida: ${n}`,"success")}async function processFirmaSupervisor(e){log("Procesando firma del supervisor [121]","info");let t=null;const n=document.querySelectorAll("span");for(const e of n){const n=e.textContent.trim();if(n.includes("[121]")&&n.includes("FIRMA")&&n.includes("SUPERVISOR")){const n=e.closest(".flex");if(n&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t)){log("Bot贸n de editar supervisor encontrado","success");break}}}if(!t){const e=document.querySelectorAll(".flex.justify-between");for(const n of e)if(n.textContent.includes("[121]")&&n.textContent.includes("SUPERVISOR")&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t))break}if(!t)return void log("Bot贸n de editar supervisor no encontrado","warning");simulateClick(t),await delay(CONFIG.delays.long);let o=await waitForModal("FIRMA DEL SUPERVISOR");if(o||(o=await waitForModal("NUEVA FIRMA")),!o)return void log("Modal de firma supervisor no apareci贸","error");const a=o.querySelector("legend button .anticon-search")?.closest("button")||o.querySelector("button .anticon-search")?.closest("button");a&&(simulateClick(a),await delay(CONFIG.delays.long),await searchAndSelectPersonal(e["final-supervisor-nombre"])),await delay(CONFIG.delays.long);let i=await waitForModal("FIRMA DEL SUPERVISOR");if(i||(i=await waitForModal("NUEVA FIRMA")),i){await setFechaFirmaModal(i,e["final-supervisor-fecha"]),await delay(CONFIG.delays.medium);const t=i.querySelector(".ant-modal-footer button.ant-btn-primary");t&&(simulateClick(t),log("Firma supervisor guardada","success"))}await delay(CONFIG.delays.extraLong)}async function processFirmaTecnico(e){log("Procesando firma del t茅cnico catastral [122]","info");let t=null;const n=document.querySelectorAll("span");for(const e of n){const n=e.textContent.trim();if(n.includes("[122]")&&n.includes("FIRMA")&&n.includes("CNICO")){const n=e.closest(".flex");if(n&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t)){log("Bot贸n de editar t茅cnico encontrado","success");break}}}if(!t){const e=document.querySelectorAll(".flex.justify-between");for(const n of e)if(n.textContent.includes("[122]")&&n.textContent.includes("CNICO")&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t))break}if(!t)return void log("Bot贸n de editar t茅cnico no encontrado","warning");simulateClick(t),await delay(CONFIG.delays.long);let o=await waitForModal("CNICO CATASTRAL");if(o||(o=await waitForModal("NUEVA FIRMA")),!o)return void log("Modal de firma t茅cnico no apareci贸","error");const a=o.querySelector("legend button .anticon-search")?.closest("button")||o.querySelector("button .anticon-search")?.closest("button");a&&(simulateClick(a),await delay(CONFIG.delays.long),await searchAndSelectPersonal(e["final-tecnico-nombre"])),await delay(CONFIG.delays.long);let i=await waitForModal("CNICO CATASTRAL");if(i||(i=await waitForModal("NUEVA FIRMA")),i){await setFechaFirmaModal(i,e["final-tecnico-fecha"]),await delay(CONFIG.delays.medium);const t=i.querySelector(".ant-modal-footer button.ant-btn-primary");t&&(simulateClick(t),log("Firma t茅cnico guardada","success"))}await delay(CONFIG.delays.extraLong)}async function handleNuevoCotitularModal(e){try{log("Procesando modal de Nuevo Cotitular","info");const t=await waitForModal("NUEVO COTITULAR CATASTRAL");if(!t)return void log("Modal de nuevo cotitular no encontrado","error");if(await delay(CONFIG.delays.medium),e["ubicacion-manzana"]){const n=findInputByLegend(t,"MANZANA")||findInputByLegend(t,"[17]");n&&(simulateInput(n,e["ubicacion-manzana"]),log("Manzana seteada: "+e["ubicacion-manzana"],"success"))}if(e["ubicacion-lote"]){const n=findInputByLegend(t,"LOTE")||findInputByLegend(t,"[18]");n&&!n.closest("fieldset")?.querySelector("legend")?.textContent.includes("SUB")&&(simulateInput(n,e["ubicacion-lote"]),log("Lote seteado: "+e["ubicacion-lote"],"success"))}if(e["ubicacion-sub-lote"]){const n=findInputByLegend(t,"SUB-LOTE")||findInputByLegend(t,"SUB LOTE")||findInputByLegend(t,"[19]");n&&(simulateInput(n,e["ubicacion-sub-lote"]),log("Sub-Lote seteado: "+e["ubicacion-sub-lote"],"success"))}if(e["ubicacion-n-municipal"]){const n=findInputByLegend(t,"MUNICIPAL")||findInputByLegend(t,"[11]");n&&(simulateInput(n,e["ubicacion-n-municipal"]),log("N掳 Municipal seteado: "+e["ubicacion-n-municipal"],"success"))}await delay(CONFIG.delays.medium),log("Seleccionando Provincia: TACNA","info");await selectByLegend(t,"PROVINCIA",CONFIG.defaultValues.provinciaDefault)&&log("Provincia TACNA seleccionada","success"),await delay(CONFIG.delays.long),log("Seleccionando Distrito: "+CONFIG.defaultValues.distritoDefault,"info");if(await selectByLegend(t,"DISTRITO",CONFIG.defaultValues.distritoDefault)&&log("Distrito seleccionado","success"),await delay(CONFIG.delays.medium),e["ubicacion-codigo-via"]){const n=findInputByLegend(t,"DIGO V")||findInputByLegend(t,"CODIGO VIA")||findInputByLegend(t,"[07]");if(n){simulateInput(n,e["ubicacion-codigo-via"]),log("C贸digo V铆a seteado: "+e["ubicacion-codigo-via"],"success"),await delay(CONFIG.delays.short);const o=findSearchButtonByLegend(t,"DIGO V")||findSearchButtonByLegend(t,"CODIGO VIA")||findSearchButtonByLegend(t,"[07]");o&&(simulateClick(o),log("Click en bot贸n de b煤squeda de C贸digo V铆a","info"),await delay(CONFIG.delays.long),await handleModalSearch("LISTADO DE V",e["ubicacion-codigo-via"]))}}if(await delay(CONFIG.delays.medium),e["ubicacion-codigo-hu"]){const n=findInputByLegend(t,"DIGO HU")||findInputByLegend(t,"CODIGO HU")||findInputByLegend(t,"[14]");if(n){simulateInput(n,e["ubicacion-codigo-hu"]),log("C贸digo HU seteado: "+e["ubicacion-codigo-hu"],"success"),await delay(CONFIG.delays.short);const o=findSearchButtonByLegend(t,"DIGO HU")||findSearchButtonByLegend(t,"CODIGO HU")||findSearchButtonByLegend(t,"[14]");o&&(simulateClick(o),log("Click en bot贸n de b煤squeda de C贸digo HU","info"),await delay(CONFIG.delays.long),await handleModalSearch("LISTADO DE HABITACIONES URBANAS",e["ubicacion-codigo-hu"]))}}log("Modal de nuevo cotitular procesado","success")}catch(e){log("Error en modal de nuevo cotitular: "+e.message,"error")}}function waitForGuardarPrincipalesClick(){return new Promise(e=>{log("Configurando listener para bot贸n Guardar principales...","info");const t=n=>{const o=n.target.closest("button");if(!o)return;(o.textContent||"").includes("Guardar principales")&&(log("Click detectado en Guardar principales!","success"),document.removeEventListener("click",t,!0),e(o))};document.addEventListener("click",t,!0)})}function waitForNuevoCotitularClick(){return new Promise(e=>{log("Configurando listener para bot贸n NUEVO en secci贸n Cotitulares...","info");const t=n=>{const o=n.target.closest("button");if(!o)return;const a=o.textContent||"",i=o.querySelector(".anticon-plus"),l=o.closest(".ant-collapse-item"),c=l?.querySelector(".ant-collapse-header-text"),r=c?.textContent||"";(a.includes("NUEVO")||i)&&r.includes("DATOS DEL COTITULAR")&&(log("Click detectado en NUEVO de secci贸n Cotitulares!","success"),document.removeEventListener("click",t,!0),setTimeout(()=>e(o),CONFIG.delays.long))};document.addEventListener("click",t,!0)})}function waitForObservacionesButtonClick(){return new Promise(e=>{log("Configurando listener para bot贸n Guardar observaciones...","info");const t=n=>{const o=n.target.closest("button");if(!o)return;(o.textContent||"").includes("Guardar observaciones")&&(log("Click detectado en Guardar observaciones!","success"),document.removeEventListener("click",t,!0),e(o))};document.addEventListener("click",t,!0)})}async function expandSection(e){const t=document.querySelectorAll(".ant-collapse-item")[e];if(!t)return log(`Secci贸n ${e} no encontrada`,"error"),!1;if(!t.classList.contains("ant-collapse-item-active")){const n=t.querySelector(".ant-collapse-header");n&&(simulateClick(n),await delay(CONFIG.delays.long),log(`Secci贸n ${e+1} expandida`,"success"))}return!0}async function handleSeccionFinal(){log("Procesando seccion final: FIRMAS","info");const e=CotitularidadState.storedData.final||{};log('Esperando click en bot贸n "Guardar observaciones"...',"info"),await waitForObservacionesButtonClick(),log("Usuario guard贸 observaciones","success"),await delay(CONFIG.delays.long),e["final-supervisor-nombre"]&&await processFirmaSupervisor(e),await delay(CONFIG.delays.long),e["final-tecnico-nombre"]&&await processFirmaTecnico(e),log("Seccion final completada","success")}async function verifyLicenseForCotitularidad(){try{const e=await LicenseManager.verifyLicense();return e.valid?(CotitularidadState.licenseValid=!0,log("Licencia verificada correctamente","success"),!0):(CotitularidadState.licenseValid=!1,log("Licencia no v谩lida","error"),showLicenseNotification(e),!1)}catch(e){return log("Error al verificar licencia: "+e.message,"error"),CotitularidadState.licenseValid=!1,!1}}function showLicenseNotification(e){const t=document.getElementById("license-notification-kda");t&&t.remove();const n=document.createElement("div");n.id="license-notification-kda",n.innerHTML=`\n    <div style="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);\n      color: white;\n      padding: 20px 25px;\n      border-radius: 12px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.3);\n      z-index: 999999;\n      max-width: 350px;\n      font-family: 'Segoe UI', Arial, sans-serif;\n    ">\n      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">\n        <span style="font-size: 28px;"></span>\n        <strong style="font-size: 16px;">Webinar Catastro - Licencia Requerida</strong>\n      </div>\n      <p style="margin: 0 0 15px 0; font-size: 13px; opacity: 0.95; line-height: 1.5;">\n        ${e.expired?"Su licencia ha expirado. Por favor renueve para continuar usando la extensi贸n.":e.notFound?"Licencia no encontrada. Por favor active su licencia.":"Se requiere una licencia v谩lida para usar esta extensi贸n."}\n      </p>\n      <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.8;">\n        La automatizaci贸n de cotitularidad no se ejecutar谩 hasta que active una licencia v谩lida.\n      </p>\n      <div style="display: flex; gap: 10px; flex-wrap: wrap;">\n        <a href="https://wa.me/51${LICENSE_CONFIG.SUPPORT_PHONE}" target="_blank" style="\n          padding: 8px 16px;\n          background: white;\n          color: #16a34a;\n          text-decoration: none;\n          border-radius: 6px;\n          font-size: 12px;\n          font-weight: 600;\n        "> Contactar: ${LICENSE_CONFIG.SUPPORT_PHONE}</a>\n        <button onclick="this.closest('#license-notification-kda').remove()" style="\n          padding: 8px 16px;\n          background: rgba(255,255,255,0.2);\n          color: white;\n          border: none;\n          border-radius: 6px;\n          font-size: 12px;\n          cursor: pointer;\n        ">Cerrar</button>\n      </div>\n    </div>\n  `,document.body.appendChild(n),setTimeout(()=>{const e=document.getElementById("license-notification-kda");e&&e.remove()},3e4)}async function initCotitularidad(){log("Verificando licencia...","info");await verifyLicenseForCotitularidad()?(log("Iniciando automatizaci贸n de Ficha Catastral Cotitularidad","info"),CotitularidadState.storedData=await getStoredData(),log("Datos cargados del storage","success"),await delay(CONFIG.delays.extraLong),log('Esperando click en "Guardar principales" para desplegar secci贸n de Cotitulares...',"info"),await waitForGuardarPrincipalesClick(),log("Usuario guard贸 principales","success"),await delay(CONFIG.delays.long),await expandSection(1),setupNuevoCotitularListener(),setupObservacionesListener()):log("Automatizaci贸n detenida: Licencia no v谩lida","error")}function setupNuevoCotitularListener(){log("Configurando listener continuo para bot贸n NUEVO...","info");document.addEventListener("click",async e=>{const t=e.target.closest("button");if(!t)return;const n=t.textContent||"",o=t.querySelector(".anticon-plus"),a=t.closest(".ant-collapse-item"),i=a?.querySelector(".ant-collapse-header-text"),l=i?.textContent||"";if((n.includes("NUEVO")||o)&&l.includes("DATOS DEL COTITULAR")){log("Click detectado en NUEVO de secci贸n Cotitulares!","success"),await delay(CONFIG.delays.long);const e=CotitularidadState.storedData.ubicacion||{};await handleNuevoCotitularModal(e)}},!0)}function setupObservacionesListener(){log("Configurando listener para Guardar observaciones...","info"),setObservacionesFromStorage();const e=async t=>{const n=t.target.closest("button");if(!n)return;if((n.textContent||"").includes("Guardar observaciones")){log("Click detectado en Guardar observaciones!","success"),document.removeEventListener("click",e,!0),await delay(CONFIG.delays.long);const t=CotitularidadState.storedData.final||{};t["final-supervisor-nombre"]&&await processFirmaSupervisor(t),await delay(CONFIG.delays.long),t["final-tecnico-nombre"]&&await processFirmaTecnico(t),log("Secci贸n final completada","success")}};document.addEventListener("click",e,!0)}function setObservacionesFromStorage(){const e=CotitularidadState.storedData?.final||{};if(e["final-observaciones"]){const t=document.querySelector("#form_item_observacion")||document.querySelector('textarea[id*="observacion"]');t?(simulateInput(t,e["final-observaciones"]),log("Observaciones seteadas: "+e["final-observaciones"].substring(0,50)+"...","success")):(log("Textarea de observaciones no encontrado, reintentando...","warning"),setTimeout(()=>{const t=document.querySelector("#form_item_observacion")||document.querySelector('textarea[id*="observacion"]');t&&e["final-observaciones"]&&(simulateInput(t,e["final-observaciones"]),log("Observaciones seteadas en reintento","success"))},CONFIG.delays.extraLong))}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initCotitularidad):initCotitularidad();