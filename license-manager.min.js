// @ts-nocheck
const LicenseManager={async checkLicenseOnline(e){try{const a=await fetch(`${LICENSE_CONFIG.API_URL}${LICENSE_CONFIG.CHECK_ENDPOINT}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({codigo:e})});return await a.json()}catch(e){return console.error("[License] Error al verificar licencia online:",e),{success:!1,message:"Error de conexión. Verificando licencia local...",connectionError:!0}}},async saveLicenseData(e,a){const i={[LICENSE_CONFIG.STORAGE_KEYS.LICENSE_CODE]:e,[LICENSE_CONFIG.STORAGE_KEYS.LICENSE_DATA]:{success:a.success,expired:a.expired||!1,expira_en:a.expira_en,message:a.message},[LICENSE_CONFIG.STORAGE_KEYS.LAST_CHECK]:(new Date).toISOString()};return new Promise(e=>{chrome.storage.local.set(i,e)})},getSavedLicenseData:async()=>new Promise(e=>{chrome.storage.local.get([LICENSE_CONFIG.STORAGE_KEYS.LICENSE_CODE,LICENSE_CONFIG.STORAGE_KEYS.LICENSE_DATA,LICENSE_CONFIG.STORAGE_KEYS.LAST_CHECK],a=>{e({code:a[LICENSE_CONFIG.STORAGE_KEYS.LICENSE_CODE]||null,data:a[LICENSE_CONFIG.STORAGE_KEYS.LICENSE_DATA]||null,lastCheck:a[LICENSE_CONFIG.STORAGE_KEYS.LAST_CHECK]||null})})}),clearLicenseData:async()=>new Promise(e=>{chrome.storage.local.remove([LICENSE_CONFIG.STORAGE_KEYS.LICENSE_CODE,LICENSE_CONFIG.STORAGE_KEYS.LICENSE_DATA,LICENSE_CONFIG.STORAGE_KEYS.LAST_CHECK],e)}),needsOnlineCheck(e){if(!e)return!0;const a=new Date(e);return(new Date-a)/36e5>=LICENSE_CONFIG.LOCAL_CHECK_INTERVAL},isLicenseExpiredLocally(e){if(!e||!e.expira_en)return!0;const a=new Date(e.expira_en);return new Date>a},async verifyLicense(e=!1){const a=await this.getSavedLicenseData();if(!a.code)return{valid:!1,needsActivation:!0,message:"Por favor ingrese su código de licencia"};if(e||this.needsOnlineCheck(a.lastCheck)){const e=await this.checkLicenseOnline(a.code);return e.connectionError?this.verifyLocally(a):e.success?(await this.saveLicenseData(a.code,e),{valid:!0,expira_en:e.expira_en,message:e.message}):e.expired?(await this.saveLicenseData(a.code,e),{valid:!1,expired:!0,expira_en:e.expira_en,message:e.message}):(await this.clearLicenseData(),{valid:!1,notFound:!0,message:e.message})}return this.verifyLocally(a)},verifyLocally(e){return e.data?this.isLicenseExpiredLocally(e.data)?{valid:!1,expired:!0,expira_en:e.data.expira_en,message:"La licencia ha expirado"}:{valid:!0,expira_en:e.data.expira_en,message:"Licencia válida (verificación local)",isLocalCheck:!0}:{valid:!1,needsActivation:!0,message:"Por favor ingrese su código de licencia"}},async activateLicense(e){if(!e||""===e.trim())return{success:!1,message:"Por favor ingrese un código de licencia válido"};const a=await this.checkLicenseOnline(e.trim());return a.connectionError?{success:!1,message:"Error de conexión. Por favor verifique su conexión a internet e intente nuevamente."}:a.success?(await this.saveLicenseData(e.trim(),a),{success:!0,expira_en:a.expira_en,message:"Licencia activada correctamente"}):a.expired?{success:!1,expired:!0,expira_en:a.expira_en,message:a.message}:{success:!1,notFound:!0,message:a.message}},formatExpirationDate(e){if(!e)return"No disponible";return new Date(e).toLocaleDateString("es-PE",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})},getDaysRemaining(e){if(!e)return 0;const a=new Date(e)-new Date;return Math.max(0,Math.ceil(a/864e5))}};