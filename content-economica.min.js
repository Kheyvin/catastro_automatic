// @ts-nocheck
const CONFIG={delays:{short:200,medium:300,long:500,extraLong:800}},EconomicaState={storedData:{},licenseValid:!1,domicilioFiscalProcesado:!1,guardarInformacionListenerActivo:!1};function log(e,t="info"){const n={info:"color: #2196F3",success:"color: #4CAF50",warning:"color: #FF9800",error:"color: #f44336"};console.log(`%c[Economica] ${e}`,n[t]||n.info)}function delay(e){return new Promise(t=>setTimeout(t,e))}async function getStoredData(){return new Promise(e=>{"undefined"!=typeof chrome&&chrome.storage?chrome.storage.local.get(["fichaCatastralData"],t=>{e(t.fichaCatastralData||{})}):e({})})}function simulateClick(e){if(!e)return;["mousedown","mouseup","click"].forEach(t=>{const n=new MouseEvent(t,{bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(n)})}function simulateInput(e,t){if(!e||null==t)return;e.focus();const n="TEXTAREA"===e.tagName;if("INPUT"===e.tagName||n){const o=n?window.HTMLTextAreaElement.prototype:window.HTMLInputElement.prototype,a=Object.getOwnPropertyDescriptor(o,"value")?.set;a?a.call(e,t):e.value=t}else e.value=t;e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("blur",{bubbles:!0}))}function simulateEnter(e){if(!e)return;const t=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});e.dispatchEvent(t)}function findInputByLegend(e,t){const n=e.querySelectorAll("legend, label, p");for(const e of n)if(e.textContent.toUpperCase().includes(t.toUpperCase())){const t=e.closest("fieldset, .ant-form-item, div");if(t){const e=t.querySelector('input:not([type="hidden"]), textarea');if(e)return e}}return null}function findSearchButtonByLegend(e,t){const n=e.querySelectorAll("legend, label, p");for(const e of n)if(e.textContent.toUpperCase().includes(t.toUpperCase())){const t=e.closest("fieldset, .ant-form-item, div");if(t){const e=t.querySelector("button .anticon-search")?.closest("button")||t.querySelector('button[type="button"]');if(e)return e}}return null}async function waitForModal(e){return new Promise(t=>{let n=0;const o=()=>{const a=document.querySelectorAll(".ant-modal");for(const n of a){const o=n.querySelector(".ant-modal-title");if(o&&o.textContent.toUpperCase().includes(e.toUpperCase()))return void t(n)}n++,n<20?setTimeout(o,CONFIG.delays.medium):(log(`Modal "${e}" no encontrado despu茅s de 20 intentos`,"warning"),t(null))};o()})}async function waitForModalToClose(e){return new Promise(t=>{let n=0;const o=()=>{const a=document.querySelectorAll(".ant-modal");let i=!1;for(const t of a){const n=t.querySelector(".ant-modal-title");if(n&&n.textContent.toUpperCase().includes(e.toUpperCase())){i=!0;break}}i?(n++,n<120?setTimeout(o,CONFIG.delays.medium):(log(`Timeout esperando cierre de modal "${e}"`,"warning"),t())):t()};setTimeout(o,CONFIG.delays.medium)})}async function searchAndSelectPersonal(e){if(!e)return!1;const t=await waitForModal("PERSONAL");if(!t)return log("Modal de b煤squeda de personal no encontrado","warning"),!1;await delay(CONFIG.delays.medium);const n=t.querySelector("input#form_item_search")||t.querySelector('input[type="text"]');if(n){simulateInput(n,e),await delay(CONFIG.delays.short);const o=t.querySelector("button.ant-input-search-button")||t.querySelector("button .anticon-search")?.closest("button");o&&(simulateClick(o),await delay(CONFIG.delays.long))}const o=t.querySelector("p.float-right span.text-black"),a=o?parseInt(o.textContent):0;if(log(`Total de registros encontrados: ${a}`,"info"),1===a){const e=t.querySelector("button .anticon-select")?.closest("button");if(e)return await delay(CONFIG.delays.short),simulateClick(e),log("Personal seleccionado autom谩ticamente","success"),await delay(CONFIG.delays.medium),!0}else{if(a>1)return log(`Se encontraron ${a} registros. Esperando selecci贸n manual...`,"warning"),await waitForModalToClose("LISTADO DEL PERSONAL"),!0;{log("No se encontraron registros","warning");const e=t.querySelector(".ant-modal-close");e&&simulateClick(e)}}return!1}async function setFechaFirmaModal(e,t){if(!t)return;const n=t;log(`Estableciendo fecha: ${n}`,"info");const o=e.querySelector("input#form_item_fecharegistro")||e.querySelector('input[placeholder*="DD"]')||e.querySelector(".ant-picker input");if(!o)return void log("Input de fecha no encontrado","warning");o.focus(),await delay(CONFIG.delays.short),o.value="",o.dispatchEvent(new Event("input",{bubbles:!0})),await delay(100),simulateEnter(o);for(let e=0;e<n.length;e++)o.value+=n[e],o.dispatchEvent(new Event("input",{bubbles:!0})),await delay(30);o.dispatchEvent(new Event("change",{bubbles:!0})),o.dispatchEvent(new Event("blur",{bubbles:!0})),simulateEnter(o),await delay(CONFIG.delays.short);const a=e.querySelector(".ant-modal-body");a&&simulateClick(a),await delay(CONFIG.delays.short),log(`Fecha establecida: ${n}`,"success")}async function verifyLicenseForEconomica(){try{const e=await LicenseManager.verifyLicense();return e.valid?(EconomicaState.licenseValid=!0,log("Licencia verificada correctamente","success"),!0):(EconomicaState.licenseValid=!1,log("Licencia no v谩lida","error"),showLicenseNotification(e),!1)}catch(e){return log("Error al verificar licencia: "+e.message,"error"),EconomicaState.licenseValid=!1,!1}}function showLicenseNotification(e){const t=document.getElementById("license-notification-kda");t&&t.remove();const n=document.createElement("div");n.id="license-notification-kda",n.innerHTML=`\n    <div style="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);\n      color: white;\n      padding: 20px 25px;\n      border-radius: 12px;\n      box-shadow: 0 10px 40px rgba(0,0,0,0.3);\n      z-index: 999999;\n      max-width: 350px;\n      font-family: 'Segoe UI', Arial, sans-serif;\n    ">\n      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">\n        <span style="font-size: 28px;"></span>\n        <strong style="font-size: 16px;">Webinar Catastro - Licencia Requerida</strong>\n      </div>\n      <p style="margin: 0 0 15px 0; font-size: 13px; opacity: 0.95; line-height: 1.5;">\n        ${e.expired?"Su licencia ha expirado. Por favor renueve para continuar usando la extensi贸n.":e.notFound?"Licencia no encontrada. Por favor active su licencia.":"Se requiere una licencia v谩lida para usar esta extensi贸n."}\n      </p>\n      <p style="margin: 0 0 15px 0; font-size: 12px; opacity: 0.8;">\n        La automatizaci贸n de ficha econ贸mica no se ejecutar谩 hasta que active una licencia v谩lida.\n      </p>\n      <div style="display: flex; gap: 10px; flex-wrap: wrap;">\n        <a href="https://wa.me/51${LICENSE_CONFIG.SUPPORT_PHONE}" target="_blank" style="\n          padding: 8px 16px;\n          background: white;\n          color: #16a34a;\n          text-decoration: none;\n          border-radius: 6px;\n          font-size: 12px;\n          font-weight: 600;\n        "> Contactar: ${LICENSE_CONFIG.SUPPORT_PHONE}</a>\n        <button onclick="this.closest('#license-notification-kda').remove()" style="\n          padding: 8px 16px;\n          background: rgba(255,255,255,0.2);\n          color: white;\n          border: none;\n          border-radius: 6px;\n          font-size: 12px;\n          cursor: pointer;\n        ">Cerrar</button>\n      </div>\n    </div>\n  `,document.body.appendChild(n),setTimeout(()=>{const e=document.getElementById("license-notification-kda");e&&e.remove()},3e4)}async function expandSection(e){const t=document.querySelectorAll(".ant-collapse-item")[e];if(!t)return log(`Secci贸n ${e} no encontrada`,"error"),!1;if(!t.classList.contains("ant-collapse-item-active")){const n=t.querySelector(".ant-collapse-header");n&&(simulateClick(n),await delay(CONFIG.delays.long),log(`Secci贸n ${e+1} expandida`,"success"))}return!0}async function expandSectionByName(e){const t=document.querySelectorAll(".ant-collapse-item");for(let n=0;n<t.length;n++){const o=t[n].querySelector(".ant-collapse-header-text");if(o&&o.textContent.toUpperCase().includes(e.toUpperCase())){if(!t[n].classList.contains("ant-collapse-item-active")){const o=t[n].querySelector(".ant-collapse-header");o&&(simulateClick(o),await delay(CONFIG.delays.long),log(`Secci贸n "${e}" expandida`,"success"))}return{section:t[n],index:n}}}return log(`Secci贸n "${e}" no encontrada`,"warning"),null}function setObservacionesFromStorage(){const e=EconomicaState.storedData?.final||{};if(e["final-observaciones"]){const t=document.getElementById("form_item_observaciones")||document.querySelector("textarea#form_item_observaciones")||document.querySelector('textarea[id*="observacion"]')||document.querySelector("#form_item_observacion");return t?(t.focus(),t.value=e["final-observaciones"],t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new Event("blur",{bubbles:!0})),log("Observaciones seteadas: "+e["final-observaciones"].substring(0,50)+"...","success"),!0):(log("Textarea de observaciones no encontrado, reintentando...","warning"),setTimeout(()=>{const t=document.getElementById("form_item_observaciones")||document.querySelector("textarea#form_item_observaciones")||document.querySelector('textarea[id*="observacion"]')||document.querySelector("#form_item_observacion");t&&e["final-observaciones"]&&(t.focus(),t.value=e["final-observaciones"],t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new Event("blur",{bubbles:!0})),log("Observaciones seteadas en reintento","success"))},CONFIG.delays.extraLong),!1)}return!0}async function setDomicilioFiscalFromStorage(){if(EconomicaState.domicilioFiscalProcesado)return void log("Domicilio fiscal ya fue procesado anteriormente","info");EconomicaState.domicilioFiscalProcesado=!0;const e=EconomicaState.storedData?.ubicacion||{},t=document.querySelectorAll(".ant-collapse-item");let n=null;for(const e of t){const t=e.querySelector(".ant-collapse-header-text");if(t&&t.textContent.includes("DOMICILIO FISCAL")){n=e;break}}if(!n)return log("Secci贸n de Domicilio Fiscal no encontrada","error"),void(EconomicaState.domicilioFiscalProcesado=!1);if(await delay(CONFIG.delays.medium),e["ubicacion-n-municipal"]){const t=findInputByLegend(n,"N掳 MUNICIPAL")||findInputByLegend(n,"MUNICIPAL");t&&(simulateInput(t,e["ubicacion-n-municipal"]),log(`N掳 Municipal seteado: ${e["ubicacion-n-municipal"]}`,"success"))}if(e["ubicacion-manzana"]){const t=findInputByLegend(n,"MANZANA");t&&(simulateInput(t,e["ubicacion-manzana"]),log(`Manzana seteada: ${e["ubicacion-manzana"]}`,"success"))}if(e["ubicacion-lote"]){const t=findInputByLegend(n,"LOTE");t&&(simulateInput(t,e["ubicacion-lote"]),log(`Lote seteado: ${e["ubicacion-lote"]}`,"success"))}if(e["ubicacion-sub-lote"]){const t=findInputByLegend(n,"SUB-LOTE")||findInputByLegend(n,"SUBLOTE");t&&(simulateInput(t,e["ubicacion-sub-lote"]),log(`Sub-Lote seteado: ${e["ubicacion-sub-lote"]}`,"success"))}e["ubicacion-codigo-via"]&&await handleCodigoViaModal(n,e["ubicacion-codigo-via"]),e["ubicacion-codigo-hu"]&&await handleCodigoHuModal(n,e["ubicacion-codigo-hu"]),log("Domicilio fiscal procesado completamente","success")}async function handleCodigoViaModal(e,t){const n=findSearchButtonByLegend(e,"DIGO VA")||findSearchButtonByLegend(e,"CODIGO VIA")||findSearchButtonByLegend(e,"[07]");if(!n){log("Bot贸n de b煤squeda de c贸digo v铆a no encontrado","warning");const n=findInputByLegend(e,"DIGO VA")||findInputByLegend(e,"CODIGO VIA");return void(n&&(simulateInput(n,t),log(`C贸digo v铆a seteado directamente: ${t}`,"success")))}simulateClick(n),await delay(CONFIG.delays.long);const o=await waitForModal("VA")||await waitForModal("VIA");if(!o)return void log("Modal de c贸digo v铆a no apareci贸","warning");const a=o.querySelector("input#form_item_search")||o.querySelector('input[type="text"]');if(a){simulateInput(a,t),await delay(CONFIG.delays.short);const e=o.querySelector("button.ant-input-search-button")||o.querySelector("button .anticon-search")?.closest("button");e&&(simulateClick(e),await delay(CONFIG.delays.long))}const i=o.querySelector("p.float-right span.text-black"),c=i?parseInt(i.textContent):0;if(1===c){const e=o.querySelector("button .anticon-select")?.closest("button");e&&(simulateClick(e),log("C贸digo v铆a seleccionado autom谩ticamente","success"))}else if(c>1)log(`Se encontraron ${c} registros para c贸digo v铆a. Usuario debe seleccionar.`,"warning"),await waitForModalToClose("VA");else{log("No se encontraron registros para c贸digo v铆a","warning");const e=o.querySelector(".ant-modal-close");e&&simulateClick(e)}}async function handleCodigoHuModal(e,t){const n=findSearchButtonByLegend(e,"DIGO HU")||findSearchButtonByLegend(e,"CODIGO HU")||findSearchButtonByLegend(e,"[18]");if(!n){log("Bot贸n de b煤squeda de c贸digo HU no encontrado","warning");const n=findInputByLegend(e,"DIGO HU")||findInputByLegend(e,"CODIGO HU");return void(n&&(simulateInput(n,t),log(`C贸digo HU seteado directamente: ${t}`,"success")))}simulateClick(n),await delay(CONFIG.delays.long);const o=await waitForModal("HAB")||await waitForModal("URBANA");if(!o)return void log("Modal de c贸digo HU no apareci贸","warning");const a=o.querySelector("input#form_item_search")||o.querySelector('input[type="text"]');if(a){simulateInput(a,t),await delay(CONFIG.delays.short);const e=o.querySelector("button.ant-input-search-button")||o.querySelector("button .anticon-search")?.closest("button");e&&(simulateClick(e),await delay(CONFIG.delays.long))}const i=o.querySelector("p.float-right span.text-black"),c=i?parseInt(i.textContent):0;if(1===c){const e=o.querySelector("button .anticon-select")?.closest("button");e&&(simulateClick(e),log("C贸digo HU seleccionado autom谩ticamente","success"))}else if(c>1)log(`Se encontraron ${c} registros para c贸digo HU. Usuario debe seleccionar.`,"warning"),await waitForModalToClose("HAB");else{log("No se encontraron registros para c贸digo HU","warning");const e=o.querySelector(".ant-modal-close");e&&simulateClick(e)}}async function processFirmaSupervisor(e){log("Procesando firma del supervisor [121]","info");let t=null;const n=document.querySelectorAll("span");for(const e of n){const n=e.textContent.trim();if(n.includes("[121]")&&n.includes("FIRMA")&&n.includes("SUPERVISOR")){const n=e.closest(".flex");if(n&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t)){log("Bot贸n de editar supervisor encontrado","success");break}}}if(!t){const e=document.querySelectorAll(".flex.justify-between");for(const n of e)if(n.textContent.includes("[121]")&&n.textContent.includes("SUPERVISOR")&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t))break}if(!t)return void log("Bot贸n de editar supervisor no encontrado","warning");simulateClick(t),await delay(CONFIG.delays.long);let o=await waitForModal("FIRMA DEL SUPERVISOR");if(o||(o=await waitForModal("NUEVA FIRMA")),!o)return void log("Modal de firma supervisor no apareci贸","error");const a=o.querySelector("legend button .anticon-search")?.closest("button")||o.querySelector("button .anticon-search")?.closest("button");a&&(simulateClick(a),await delay(CONFIG.delays.long),await searchAndSelectPersonal(e["final-supervisor-nombre"])),await delay(CONFIG.delays.long);let i=await waitForModal("FIRMA DEL SUPERVISOR");if(i||(i=await waitForModal("NUEVA FIRMA")),i){await setFechaFirmaModal(i,e["final-supervisor-fecha"]),await delay(CONFIG.delays.medium);const t=i.querySelector(".ant-modal-footer button.ant-btn-primary");t&&(simulateClick(t),log("Firma supervisor guardada","success"))}await delay(CONFIG.delays.extraLong)}async function processFirmaTecnico(e){log("Procesando firma del t茅cnico catastral [122]","info");let t=null;const n=document.querySelectorAll("span");for(const e of n){const n=e.textContent.trim();if(n.includes("[122]")&&n.includes("FIRMA")&&n.includes("CNICO")){const n=e.closest(".flex");if(n&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t)){log("Bot贸n de editar t茅cnico encontrado","success");break}}}if(!t){const e=document.querySelectorAll(".flex.justify-between");for(const n of e)if(n.textContent.includes("[122]")&&n.textContent.includes("CNICO")&&(t=n.querySelector("button .anticon-edit")?.closest("button"),t))break}if(!t)return void log("Bot贸n de editar t茅cnico no encontrado","warning");simulateClick(t),await delay(CONFIG.delays.long);let o=await waitForModal("CNICO CATASTRAL");if(o||(o=await waitForModal("NUEVA FIRMA")),!o)return void log("Modal de firma t茅cnico no apareci贸","error");const a=o.querySelector("legend button .anticon-search")?.closest("button")||o.querySelector("button .anticon-search")?.closest("button");a&&(simulateClick(a),await delay(CONFIG.delays.long),await searchAndSelectPersonal(e["final-tecnico-nombre"])),await delay(CONFIG.delays.long);let i=await waitForModal("CNICO CATASTRAL");if(i||(i=await waitForModal("NUEVA FIRMA")),i){await setFechaFirmaModal(i,e["final-tecnico-fecha"]),await delay(CONFIG.delays.medium);const t=i.querySelector(".ant-modal-footer button.ant-btn-primary");t&&(simulateClick(t),log("Firma t茅cnico guardada","success"))}await delay(CONFIG.delays.extraLong)}function setupGuardarPrincipalesListener(){log('Configurando listener para "Guardar principales"...',"info");const e=async t=>{const n=t.target.closest("button");if(!n)return;const o=n.textContent||"";if(o.includes("Guardar principales")||o.includes("Guardar Principales")){log("Click detectado en Guardar principales!","success"),document.removeEventListener("click",e,!0),await delay(CONFIG.delays.long);await expandSectionByName("INFORMACI")||await expandSectionByName("OBSERVACIONES"),await delay(CONFIG.delays.medium),setObservacionesFromStorage(),await delay(CONFIG.delays.medium),log("Activando listener para Domicilio Fiscal...","info"),setupDomicilioFiscalListener(),log("Activando listener para Guardar informaci贸n...","info"),setupGuardarInformacionListener()}};document.addEventListener("click",e,!0)}function setupDomicilioFiscalListener(){log("Configurando listener para expansi贸n de Domicilio Fiscal...","info");document.addEventListener("click",async e=>{if(EconomicaState.domicilioFiscalProcesado)return;const t=e.target.closest(".ant-collapse-header");if(!t)return;const n=t.querySelector(".ant-collapse-header-text");n&&n.textContent.includes("DOMICILIO FISCAL")&&(log("Click detectado en secci贸n Domicilio Fiscal!","success"),await delay(CONFIG.delays.long),await setDomicilioFiscalFromStorage())},!0)}function setupGuardarInformacionListener(){log('Configurando listener para "Guardar informaci贸n"...',"info");const e=async t=>{const n=t.target.closest("button");if(!n)return;const o=n.textContent||"";if(o.includes("Guardar informaci")||o.includes("Guardar Informaci")){log("Click detectado en Guardar informaci贸n!","success"),document.removeEventListener("click",e,!0),await delay(CONFIG.delays.long);const t=EconomicaState.storedData.final||{};t["final-supervisor-nombre"]&&await processFirmaSupervisor(t),await delay(CONFIG.delays.long),t["final-tecnico-nombre"]&&await processFirmaTecnico(t),log("Secci贸n final (firmas) completada","success")}};document.addEventListener("click",e,!0)}async function initEconomica(){log("Verificando licencia...","info");await verifyLicenseForEconomica()?(log("Iniciando automatizaci贸n de Ficha Catastral Econ贸mica","info"),EconomicaState.storedData=await getStoredData(),log("Datos cargados del storage","success"),await delay(CONFIG.delays.extraLong),setupGuardarPrincipalesListener(),log('Esperando click en "Guardar principales" para iniciar el flujo...',"info")):log("Automatizaci贸n detenida: Licencia no v谩lida","error")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initEconomica):initEconomica();